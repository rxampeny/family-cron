<!DOCTYPE html>
<html lang="ca">
<head>
    <meta property="og:image" content="public/icon-app.svg">
    <link rel="icon" href="public/icon-app.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="public/icon-app.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:image" content="https://victor-catala-1971.netlify.app/images/icon-app.svg">
    <meta property="og:title" content="Aniversaris familiars">
    <meta property="og:description" content="Gesti√≥ d'aniversaris familiars">
    <meta property="og:type" content="website">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://victor-catala-1971.netlify.app/victor-catala-1971.html">
    <title>Aniversaris familiars</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.0.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
        }
        
        .container {
            background-color: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 100%;
            width: 100%;
            animation: fadeIn 0.6s ease-out;
        }
        
        h1 {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0 20px 0;
            letter-spacing: -0.5px;
        }

        h1 img {
            width: 35px;
            height: 35px;
            vertical-align: middle;
            margin-right: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .main-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .main-header-icon {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .main-header-content {
            text-align: left;
        }

        .main-header-title {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0 0 5px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .main-header-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            font-weight: 500;
            margin: 0;
        }

        select {
            margin-bottom: 15px;
            padding: 12px 15px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            width: 100%;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover {
            border-color: #667eea;
            background-color: white;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        #chartContainer {
            height: 60vh;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .imatge-container {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .imatge-container img {
            max-width: 50%;
            height: auto;
            border-radius: 8px;
        }
        
        .checkbox-container {
            margin-bottom: 20px;
            padding: 14px 18px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .checkbox-container:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .checkbox-container label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            color: #495057;
        }

        .checkbox-container input[type="checkbox"] {
            margin: 0;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        /* Estilos para el modal de contrase√±a */
        #passwordModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.4s ease-out;
        }

        .login-container {
            background-color: white;
            padding: 40px 30px;
            border-radius: 24px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.3);
            text-align: center;
            width: 90%;
            max-width: 400px;
            animation: slideIn 0.5s ease-out;
        }

        .login-container img {
            width: 90px;
            height: 90px;
            margin-bottom: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .login-container h2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            font-size: 1.6rem;
            font-weight: 700;
        }

        .login-container .login-subtitle {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 25px;
            margin-top: 0;
            font-weight: 500;
        }

        .login-container p {
            margin-bottom: 20px;
            font-size: 0.95rem;
            color: #6c757d;
        }

        .login-container button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            margin-top: 15px;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .login-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .login-container button:active {
            transform: translateY(0);
        }

        .login-container input {
            width: 100%;
            padding: 14px 18px;
            margin: 10px 0;
            box-sizing: border-box;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            text-align: center;
            transition: all 0.3s ease;
        }

        .login-container input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        #logoutButton {
            padding: 10px 20px;
            margin: 10px 0;
            background: linear-gradient(135deg, #ee5a6f 0%, #f29263 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            align-self: flex-end;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(238, 90, 111, 0.4);
            transition: all 0.3s ease;
        }

        #logoutButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(238, 90, 111, 0.6);
        }

        #logoutButton:active {
            transform: translateY(0);
        }

        /* Bot√≥n de env√≠o de emails */
        .send-emails-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
            z-index: 998;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-emails-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .send-emails-btn:active {
            transform: translateY(0);
        }

        .send-emails-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Bot√≥n de env√≠o de SMS */
        .send-sms-btn {
            position: fixed;
            bottom: 20px;
            left: 170px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
            z-index: 998;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-sms-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .send-sms-btn:active {
            transform: translateY(0);
        }

        .send-sms-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Botones flotantes en m√≥viles - organizados en 2 columnas */
        @media (max-width: 768px) {
            /* COLUMNA IZQUIERDA */
            .send-emails-btn {
                padding: 10px 15px;
                font-size: 0.8rem;
                bottom: 20px;
                left: 15px;
            }

            .send-sms-btn {
                padding: 10px 15px;
                font-size: 0.8rem;
                bottom: 65px;
                left: 15px;
            }

            /* .tree-btn ya tiene sus estilos m√°s abajo, solo ajustamos bottom */

            /* COLUMNA DERECHA */
            #logoutButton {
                position: fixed;
                bottom: 20px;
                right: 15px;
                z-index: 100;
                padding: 10px 15px;
                border-radius: 30px;
                font-size: 0.8rem;
            }

            /* #chat-toggle se ajusta en su secci√≥n de estilos */

            /* .add-btn ya tiene sus estilos m√°s abajo, solo ajustamos bottom */

            .mainContent {
                width: 100%;
            }

            .container {
                margin-bottom: 200px;
                padding: 15px;
            }

            .main-header {
                flex-direction: column;
                padding: 20px;
                gap: 15px;
            }

            .main-header-icon {
                width: 60px;
                height: 60px;
            }

            .main-header-content {
                text-align: center;
            }

            .main-header-title {
                font-size: 1.5rem;
            }

            .main-header-subtitle {
                font-size: 0.9rem;
            }

            body {
                padding: 5px;
            }
        }

        @media (max-width: 400px) {
            .add-btn, .tree-btn {
                width: 50px;
                height: 50px;
                font-size: 24px;
                bottom: 100px;
            }

            .send-emails-btn, .send-sms-btn, #logoutButton, #chat-toggle {
                padding: 8px 12px;
                font-size: 0.7rem;
            }

            .container {
                margin-bottom: 180px;
            }
        }

        /* Ocultar el contenido principal hasta que se verifique la contrase√±a */
        .hidden {
            display: none !important;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-weight: 500;
        }

        /* Barra de b√∫squeda */
        .search-container {
            margin-bottom: 15px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 18px;
        }

        /* Widget de pr√≥ximos cumplea√±os */
        .upcoming-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 16px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
            cursor: pointer;
        }

        .upcoming-widget h3 {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .upcoming-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .upcoming-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
        }

        .upcoming-item:last-child {
            margin-bottom: 0;
        }

        /* Estad√≠sticas */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Modal de detalles */
        .details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }

        .details-modal.show {
            display: flex;
        }

        .details-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        .details-content h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 15px 0;
            font-size: 1.5rem;
        }

        .details-info {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .close-modal {
            background: linear-gradient(135deg, #ee5a6f 0%, #f29263 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(238, 90, 111, 0.4);
        }

        /* Modal de confirmaci√≥n */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease-out;
        }

        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            text-align: center;
        }

        .confirm-content h3 {
            color: #d32f2f;
            margin: 0 0 15px 0;
            font-size: 1.5rem;
        }

        .confirm-content p {
            color: #666;
            margin: 10px 0;
        }

        .confirm-content ul {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .confirm-content ul li {
            background: #ffebee;
            padding: 8px 15px;
            margin: 5px 0;
            border-radius: 8px;
            color: #c62828;
            font-weight: 500;
        }

        .confirm-btn {
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .confirm-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .confirm-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .confirm-btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }

        .confirm-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }

        /* Toggle modo oscuro */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            z-index: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            border-color: #667eea;
        }

        /* Modo oscuro */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-mode .container {
            background-color: #0f3460;
            color: #e4e4e4;
        }

        body.dark-mode h1 {
            -webkit-text-fill-color: #e4e4e4;
            background: none;
        }

        body.dark-mode .subtitle {
            color: #b0b0b0;
        }

        body.dark-mode .search-input,
        body.dark-mode select {
            background-color: #1a1a2e;
            color: #e4e4e4;
            border-color: #2d2d44;
        }

        body.dark-mode .checkbox-container,
        body.dark-mode .stat-card {
            background: #1a1a2e;
            border-color: #2d2d44;
            color: #e4e4e4;
        }

        body.dark-mode .stat-label,
        body.dark-mode .checkbox-container label {
            color: #b8b8b8;
        }

        body.dark-mode .theme-toggle {
            background: #0f3460;
            border-color: #2d2d44;
        }

        /* Animaci√≥n de transici√≥n entre meses */
        .chart-transition {
            animation: chartFadeIn 0.5s ease-out;
        }

        @keyframes chartFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* Modal de √°rbol geneal√≥gico */
        .family-tree-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            overflow: hidden;
        }

        .family-tree-modal.show {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease-out;
        }

        .family-tree-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .family-tree-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .tree-search-container {
            flex: 1;
            max-width: 400px;
            min-width: 200px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .tree-search-container .search-icon {
            position: absolute;
            left: 12px;
            font-size: 1.2rem;
            pointer-events: none;
            z-index: 1;
        }

        .tree-search-input {
            width: 100%;
            padding: 10px 45px 10px 40px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tree-search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .tree-search-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            border-color: white;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        .tree-search-clear {
            position: absolute;
            right: 8px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: rgba(255, 255, 255, 0.9);
            width: 26px;
            height: 26px;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 2;
        }

        .tree-search-clear:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.15);
        }

        .tree-search-clear:active {
            transform: scale(0.9);
        }

        .tree-search-clear.show {
            display: flex;
        }

        .family-tree-close {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .family-tree-close:hover {
            background: white;
            color: #667eea;
            transform: rotate(90deg);
        }

        .family-tree-container {
            flex: 1;
            position: relative;
            background: #fafafa;
            overflow: hidden;
            touch-action: pan-x pan-y pinch-zoom;
        }

        #familyTreeSVG {
            width: 100%;
            height: 100%;
        }

        /* Controles de zoom del √°rbol */
        .tree-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .tree-control-btn {
            width: 45px;
            height: 45px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            font-size: 1.3rem;
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: 600;
        }

        .tree-control-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        /* Estilos de nodos del √°rbol D3 */
        .tree-node {
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: none;
        }

        .tree-node:hover {
            transform: scale(1.05);
        }

        .tree-node:active .tree-node-circle {
            stroke-width: 6px;
            filter: drop-shadow(0 0 12px rgba(102, 126, 234, 0.8));
        }

        .tree-node-circle {
            fill: #667eea;
            stroke: #764ba2;
            stroke-width: 3px;
            transition: all 0.3s ease;
        }

        .tree-node-circle.deceased {
            fill: #9ca3af;
            stroke: #6b7280;
        }

        .tree-node-circle.female {
            fill: #ec4899;
            stroke: #db2777;
        }

        .tree-node:hover .tree-node-circle {
            stroke-width: 5px;
            filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.6));
        }

        .tree-node.dragging .tree-node-circle {
            stroke-width: 6px;
            filter: drop-shadow(0 0 12px rgba(102, 126, 234, 0.8));
            opacity: 0.7;
        }

        .tree-node-text {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            fill: #333;
            text-anchor: middle;
            pointer-events: none;
        }

        .tree-node-initials {
            font-family: 'Inter', sans-serif;
            font-size: 20px;
            font-weight: 700;
            fill: white;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
        }

        .tree-node-subtext {
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 400;
            fill: #6c757d;
            text-anchor: middle;
            pointer-events: none;
        }

        .tree-link {
            fill: none;
            stroke: #cbd5e0;
            stroke-width: 2px;
        }

        .tree-link-partner {
            stroke: #f687b3;
            stroke-width: 3px;
            stroke-dasharray: 5, 5;
        }

        /* Nodos de uni√≥n de parejas */
        .tree-node-circle.couple-union {
            fill: #fbbf24;
            stroke: #f59e0b;
            stroke-width: 2px;
            opacity: 0.8;
        }

        .tree-node:hover .tree-node-circle.couple-union {
            opacity: 1;
            stroke-width: 3px;
            filter: drop-shadow(0 0 6px rgba(251, 191, 36, 0.6));
        }

        /* Responsive styles para √°rbol en m√≥vil */
        @media (max-width: 768px) {
            .tree-node-text {
                font-size: 11px;
                max-width: 80px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .tree-node-initials {
                font-size: 16px;
            }

            .tree-node-subtext {
                font-size: 9px;
            }

            .tree-link {
                stroke-width: 1.5px;
            }

            .tree-link-partner {
                stroke-width: 2px;
            }
        }

        /* Vista de lista para m√≥vil */
        .family-list-view {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 100px; /* Extra espacio al final para scroll completo */
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch; /* Scroll suave en iOS */
        }

        .family-list-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .family-list-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .family-list-card:active {
            transform: translateY(0);
        }

        .family-list-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .family-list-icon.male {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .family-list-icon.female {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .family-list-icon.deceased {
            background: linear-gradient(135deg, #c3cfe2 0%, #a8b5c9 100%);
        }

        .family-list-icon img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .family-list-icon.has-photo {
            background: #e2e8f0;
            padding: 0;
        }

        .family-list-info {
            flex: 1;
        }

        .family-list-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 4px;
            color: #2d3748;
        }

        .family-list-details {
            font-size: 0.9rem;
            color: #718096;
        }

        .family-list-group {
            margin-bottom: 25px;
        }

        .family-list-group-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 5px;
        }

        /* Panel de relaciones expandido */
        .family-card-expanded {
            border: 2px solid #667eea !important;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2) !important;
        }

        .family-relations-panel {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }

        .relation-section {
            margin-bottom: 15px;
        }

        .relation-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .relation-mini-card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .relation-mini-card:hover {
            background: linear-gradient(135deg, #e6f0ff 0%, #f0e6ff 100%);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.2);
        }

        .relation-mini-card:active {
            transform: translateX(2px) scale(0.98);
        }

        .relation-mini-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .relation-mini-icon img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .relation-mini-icon.has-photo {
            background: #e2e8f0;
            padding: 0;
        }

        .relation-mini-info {
            flex: 1;
        }

        .relation-mini-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #2d3748;
        }

        .relation-mini-detail {
            font-size: 0.8rem;
            color: #a0aec0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .family-tree-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .family-tree-header h2 {
                font-size: 1.2rem;
                text-align: center;
            }

            .tree-search-container {
                max-width: 100%;
                order: 2;
            }

            .family-tree-close {
                position: absolute;
                top: 15px;
                right: 15px;
            }

            .tree-controls {
                top: 10px;
                right: 10px;
                gap: 5px;
            }

            .tree-control-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
        }

        /* Modo oscuro para modal de √°rbol */
        body.dark-mode .family-tree-container {
            background: #16213e;
        }

        body.dark-mode .tree-node-text {
            fill: #e4e4e4;
        }

        body.dark-mode .tree-control-btn {
            background: #0f3460;
            color: #e4e4e4;
            border-color: #e4e4e4;
        }

        body.dark-mode .tree-control-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        body.dark-mode .tree-node-subtext {
            fill: #a0aec0;
        }

        body.dark-mode .tree-link {
            stroke: #4a5568;
        }

        body.dark-mode .family-list-view {
            background: #1a1a2e;
        }

        body.dark-mode .family-list-card {
            background: #16213e;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .family-list-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .family-list-name {
            color: #e4e4e4;
        }

        body.dark-mode .family-list-details {
            color: #a0aec0;
        }

        body.dark-mode .family-list-group-title {
            color: #818cf8;
        }

        body.dark-mode .family-relations-panel {
            border-top-color: #2d3748;
        }

        body.dark-mode .relation-section-title {
            color: #a0aec0;
        }

        body.dark-mode .relation-link {
            background: #0f3460;
            color: #e4e4e4;
        }

        body.dark-mode .relation-link:hover {
            background: #667eea;
        }

        /* Vista de calendario */
        .calendar-view {
            display: block;
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 10px;
            color: #667eea;
            font-size: 0.9rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 8px;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .calendar-day:hover {
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .calendar-day.has-birthday {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        /* D√≠a actual destacado con borde dorado */
        .calendar-day.is-today {
            border: 3px solid #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.5), 0 0 25px rgba(251, 191, 36, 0.3);
            position: relative;
        }

        /* Cuando el d√≠a actual tiene cumplea√±os, combinar ambos estilos */
        .calendar-day.is-today.has-birthday {
            border: 3px solid #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.6), 0 0 25px rgba(251, 191, 36, 0.4);
        }

        /* Animaci√≥n sutil para el d√≠a actual */
        @keyframes pulse-today {
            0%, 100% {
                box-shadow: 0 0 15px rgba(251, 191, 36, 0.5), 0 0 25px rgba(251, 191, 36, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.7), 0 0 35px rgba(251, 191, 36, 0.5);
            }
        }

        .calendar-day.is-today {
            animation: pulse-today 2s ease-in-out infinite;
        }

        .calendar-day.other-month {
            opacity: 0.3;
            pointer-events: none;
        }

        .calendar-day-number {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calendar-birthday-count {
            position: absolute;
            top: 4px;
            right: 4px;
            background: white;
            color: #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .calendar-birthday-names {
            font-size: 0.65rem;
            margin-top: 4px;
            line-height: 1.2;
        }

        /* Toggle de vista */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 6px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }

        .view-toggle-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #6c757d;
        }

        .view-toggle-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Bot√≥n flotante de agregar */
        .add-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 3px solid white;
            font-size: 36px;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.8);
            }
        }

        /* Animaciones para el widget de countdown */
        @keyframes countdownPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes glow {
            0%, 100% {
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3);
            }
            50% {
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 30px rgba(255, 255, 255, 0.5);
            }
        }

        /* Clases para activar animaciones al tocar el widget */
        .upcoming-widget.active .glow-text {
            animation: glow 2s ease-in-out 2;
        }

        .upcoming-widget.active .pulse-counter {
            animation: countdownPulse 1.5s ease-in-out 3;
        }

        .add-btn:hover {
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.8);
            animation: none;
        }

        .add-btn::before {
            content: '‚ûï Afegir';
            position: absolute;
            right: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .add-btn:hover::before {
            opacity: 1;
        }

        /* Bot√≥n flotante de √°rbol geneal√≥gico */
        .tree-btn {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 36px;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: floatTree 3s ease-in-out infinite;
        }

        @keyframes floatTree {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .tree-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.8);
            animation: none;
        }

        .tree-btn::before {
            content: 'üå≥ Arbre';
            position: absolute;
            left: 80px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            white-space: nowrap;
            font-size: 14px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .tree-btn:hover::before {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .tree-btn {
                bottom: 110px;
                left: 15px;
                width: 55px;
                height: 55px;
                font-size: 28px;
            }

            .tree-btn::before {
                font-size: 12px;
                padding: 6px 12px;
                left: 65px;
            }
        }

        /* Modal de formulario */
        .form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease-out;
            overflow-y: auto;
            padding: 20px;
        }

        .form-modal.show {
            display: flex;
        }

        .form-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        .form-content h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 20px 0;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .form-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }

        .form-btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .form-btn-secondary:hover {
            background: #dee2e6;
        }

        .form-btn-danger {
            background: linear-gradient(135deg, #ee5a6f 0%, #f29263 100%);
            color: white;
        }

        .form-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(238, 90, 111, 0.5);
        }

        /* Optimizaci√≥n del modal para m√≥vil */
        @media (max-width: 768px) {
            .form-modal {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }

            .form-content {
                max-height: 85vh;
                padding: 20px 15px;
                margin-bottom: 10px;
            }

            .form-content h3 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group input,
            .form-group select {
                padding: 10px 12px;
                font-size: 16px; /* Evitar zoom autom√°tico en iOS */
            }

            .form-actions {
                flex-direction: column;
                gap: 10px;
            }

            .form-actions .form-btn {
                width: 100%;
            }

            /* Ajustes del widget de countdown para m√≥vil */
            .upcoming-widget {
                padding: 15px;
            }

            #upcomingList {
                font-size: 0.9rem !important;
            }

            #upcomingList > div {
                font-size: 1rem !important;
            }

            #upcomingList strong {
                font-size: 1.1rem !important;
            }
        }

        /* Indicador de swipe */
        .swipe-indicator {
            text-align: center;
            padding: 10px;
            color: #6c757d;
            font-size: 0.85rem;
            font-style: italic;
        }

        body.dark-mode .calendar-view,
        body.dark-mode .form-content {
            background: #0f3460;
            color: #e4e4e4;
        }

        body.dark-mode .calendar-day {
            background: #1a1a2e;
            border-color: #2d2d44;
            color: #e4e4e4;
        }

        body.dark-mode .view-toggle {
            background: #1a1a2e;
            border-color: #2d2d44;
        }

        body.dark-mode .form-group label {
            color: #e4e4e4;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group select {
            background: #1a1a2e;
            color: #e4e4e4;
            border-color: #2d2d44;
        }

        @media (max-width: 768px) {
            .add-btn {
                bottom: 110px;
                right: 15px;
                width: 55px;
                height: 55px;
                font-size: 28px;
            }

            .add-btn::before {
                font-size: 12px;
                padding: 6px 12px;
                right: 65px;
            }

            .calendar-grid {
                gap: 2px;
            }

            .calendar-day-header {
                padding: 4px 1px;
                font-size: 0.65rem;
            }

            .calendar-day {
                padding: 1px;
                font-size: 0.65rem;
                min-height: 45px;
            }

            .calendar-day-number {
                font-size: 0.65rem;
            }

            .calendar-birthday-count {
                width: 14px;
                height: 14px;
                font-size: 0.55rem;
                top: 1px;
                right: 1px;
            }

            .calendar-birthday-names {
                font-size: 0.45rem;
                line-height: 1.0;
                overflow: hidden;
                text-overflow: ellipsis;
                max-height: 22px;
            }

            .calendar-view {
                padding: 5px;
            }

            .calendar-header {
                margin-bottom: 10px;
            }

            .calendar-header h3 {
                font-size: 1.1rem !important;
            }
        }
    
        /* Chat flotant - estilos principales est√°n en la secci√≥n del chat */
        /* Solo mantenemos z-index aqu√≠ para asegurar orden correcto */
        #chat-toggle {
            z-index: 2100;
        }

        openai-chatkit{
            width:360px;
            height:520px;
            background:#fff;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(0,0,0,.25);
            overflow:hidden;
        }

        /* #chat-close estilos est√°n en la secci√≥n del chat */

    </style>
<!-- Script de OpenAI chatkit eliminado - no se usa -->
</head>
<body>
    <!-- Modal de contrase√±a -->
    <div id="passwordModal">
        <div class="login-container">
            <img src="public/icon-login.svg" alt="Aniversaris familiars">
            <h2>Aniversaris familiars</h2>
            <p class="login-subtitle">Gesti√≥ d'aniversaris i arbre familiar</p>
            <p>Si us plau, introdueix la contrasenya per accedir:</p>
            <input type="password" id="passwordInput" placeholder="contrasenya">
            <button onclick="checkPassword()">Accedir</button>
        </div>
    </div>

    <!-- Toggle modo oscuro -->
    <div class="theme-toggle" id="themeToggle" title="Cambiar tema">
        üåô
    </div>

    <!-- Contenido principal (inicialmente oculto) -->
    <div class="mainContent hidden">
        <button id="logoutButton">Tancar sessi√≥</button>
        <button id="sendEmailsBtn" class="send-emails-btn" onclick="sendBirthdayEmailsManually()" title="Enviar felicitacions d'avui">
            üìß Enviar emails
        </button>
        <button id="sendSmsBtn" class="send-sms-btn" onclick="sendBirthdaySMSManually()" title="Enviar SMS d'avui">
            üì± Enviar SMS
        </button>

        <div class="container">
            <div class="imatge-container">
                <img src="public/placeholder-familia.svg" alt="Aniversaris familiars" style="max-width: 50%; height: auto; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);" />
            </div>

            <!-- Widget de pr√≥ximos cumplea√±os (ahora muestra countdown) -->
            <div class="upcoming-widget" id="upcomingWidget">
                <div id="upcomingList" style="font-size: 1rem; color: white; line-height: 1.8; font-weight: 500;"></div>
            </div>

            <!-- Estad√≠sticas del mes -->
            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-month" id="statMonth" style="font-size: 1.3rem; font-weight: 600; margin-bottom: 8px;"></div>
                    <div class="stat-label" id="statMotivation" style="font-size: 0.9rem;"></div>
                </div>
                <div class="stat-card" style="max-height: 200px; overflow-y: auto;">
                    <div class="stat-label" style="margin-bottom: 10px; font-weight: 600;">Aniversaris del mes</div>
                    <div id="statBirthdayList" style="font-size: 0.85rem; line-height: 1.6;"></div>
                </div>
            </div>

            <!-- Barra de b√∫squeda -->
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Buscar per nom...">
            </div>

            <!-- Contenedor de resultados de b√∫squeda -->
            <div id="searchResults" style="display: none; margin-bottom: 20px;"></div>

            <select id="mesSelector"></select>

            <!-- Indicador de swipe m√≥vil -->
            <div class="swipe-indicator">üëà Llisca per canviar de mes üëâ</div>

            <!-- Vista de calendario -->
            <div class="calendar-view" id="calendarView">
                <div id="calendarContent"></div>
            </div>

            <!-- Bot√≥n flotante de agregar -->
            <button class="add-btn" id="addBtn" onclick="openAddModal()" title="Afegir aniversari">
                +
            </button>

            <!-- Bot√≥n flotante de √°rbol geneal√≥gico -->
            <button class="tree-btn" id="treeBtn" onclick="openFamilyTree()" title="Veure arbre familiar">
                üå≥
            </button>

            <!-- Modal de √°rbol geneal√≥gico -->
            <div class="family-tree-modal" id="familyTreeModal">
                <div class="family-tree-header">
                    <h2>üå≥ Arbre Geneal√≤gic Familiar</h2>
                    <!-- Buscador dentro del √°rbol -->
                    <div class="tree-search-container">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="treeSearchInput" class="tree-search-input" placeholder="Buscar persona...">
                        <button class="tree-search-clear" id="treeSearchClear" title="Netejar cerca">‚å´</button>
                    </div>
                    <button class="family-tree-close" onclick="closeFamilyTree()" title="Tancar (ESC)">
                        ‚úï
                    </button>
                </div>
                <div class="family-tree-container" id="familyTreeContainer">
                    <!-- La vista de tarjetas se renderizar√° aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de formulario -->
    <div class="form-modal" id="formModal">
        <div class="form-content">
            <h3 id="formTitle">Afegir Aniversari</h3>
            <form id="birthdayForm" onsubmit="return false;">
                <div class="form-group">
                    <label for="formNom">Nom *</label>
                    <input type="text" id="formNom" required placeholder="Nom complet">
                </div>
                <div class="form-group">
                    <label for="formDia">Dia *</label>
                    <input type="number" id="formDia" min="1" max="31" required placeholder="1-31">
                </div>
                <div class="form-group">
                    <label for="formMes">Mes *</label>
                    <select id="formMes" required>
                        <option value="">Selecciona un mes</option>
                        <option value="1">Gener</option>
                        <option value="2">Febrer</option>
                        <option value="3">Mar√ß</option>
                        <option value="4">Abril</option>
                        <option value="5">Maig</option>
                        <option value="6">Juny</option>
                        <option value="7">Juliol</option>
                        <option value="8">Agost</option>
                        <option value="9">Setembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Desembre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="formAnyNaixement">Any de naixement *</label>
                    <input type="number" id="formAnyNaixement" min="1900" max="2025" placeholder="Ex: 1971">
                </div>
                <div class="form-group">
                    <label for="formTelefon">Tel√®fon *</label>
                    <input type="text" id="formTelefon" placeholder="N√∫mero de tel√®fon">
                </div>
                <div class="form-group">
                    <label for="formEmail">Email *</label>
                    <input type="email" id="formEmail" placeholder="correu@example.com">
                </div>
                <div class="form-group">
                    <label for="formGenere">G√®nere *</label>
                    <select id="formGenere">
                        <option value="">No especificat</option>
                        <option value="H">Home</option>
                        <option value="D">Dona</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="formViu">Estat *</label>
                    <select id="formViu">
                        <option value="">No especificat</option>
                        <option value="S√≠">Viu</option>
                        <option value="No">En mem√≤ria</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="formLlocNaixement">Lloc de naixement</label>
                    <input type="text" id="formLlocNaixement" placeholder="Poblaci√≥ o pa√≠s">
                    <small style="color: #6c757d; font-size: 0.85rem; display: block; margin-top: 5px;">
                        Opcional: on va n√©ixer aquesta persona
                    </small>
                </div>

                <div class="form-group" id="formAnyMortContainer" style="display: none;">
                    <label for="formAnyMort">Any de mort</label>
                    <input type="number" id="formAnyMort" min="1900" max="2100" placeholder="Ex: 2020">
                    <small style="color: #6c757d; font-size: 0.85rem; display: block; margin-top: 5px;">
                        Si la persona ha mort, indica l'any
                    </small>
                </div>

                <!-- Secci√≥n de relaciones familiares -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                    <div style="font-weight: 600; color: #667eea; margin-bottom: 15px; font-size: 1.05rem;">
                        üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Relacions familiars (opcional)
                    </div>

                    <div class="form-group">
                        <label for="formPare">Pare</label>
                        <select id="formPare">
                            <option value="">No especificat</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="formMare">Mare</label>
                        <select id="formMare">
                            <option value="">No especificat</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="formParella">Parella</label>
                        <select id="formParella">
                            <option value="">No especificat</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="formEstatRelacio">Estat de la relaci√≥</label>
                        <select id="formEstatRelacio">
                            <option value="">No especificat</option>
                            <option value="Actual">Actual</option>
                            <option value="Pasada">Passada (amb fills)</option>
                        </select>
                        <small style="color: #6c757d; font-size: 0.85rem; display: block; margin-top: 5px;">
                            Indica si √©s la parella actual o una relaci√≥ passada
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="formUrlFoto">Foto (URL)</label>
                        <input type="url" id="formUrlFoto" placeholder="https://exemple.com/foto.jpg">
                        <small style="color: #6c757d; font-size: 0.85rem; display: block; margin-top: 5px;">
                            Opcional: enlla√ß a una imatge
                        </small>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="form-btn form-btn-secondary" onclick="closeFormModal()">Cancel¬∑lar</button>
                    <button type="button" id="deleteBtn" class="form-btn form-btn-danger hidden" onclick="deleteBirthday()">Eliminar</button>
                    <button type="submit" class="form-btn form-btn-primary" onclick="saveBirthday()">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de detalles -->
    <div class="details-modal" id="detailsModal">
        <div class="details-content">
            <h3 id="detailsName"></h3>
            <div class="details-info">
                <strong>üìÖ Data:</strong> <span id="detailsDate"></span>
            </div>
            <div class="details-info" id="detailsAgeContainer" style="display: none;">
                <strong>üéÇ Edat:</strong> <span id="detailsAge"></span>
            </div>
            <div class="details-info">
                <strong>üìû Tel√®fon:</strong> <span id="detailsPhone"></span>
            </div>
            <div class="details-info">
                <strong>üìß Email:</strong> <span id="detailsEmail"></span>
            </div>
            <div class="details-info">
                <strong>‚è∞ Dies fins al pr√≤xim aniversari:</strong> <span id="detailsDays"></span>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="close-modal" style="flex: 1;" onclick="openEditModal()">‚úèÔ∏è Editar</button>
                <button class="close-modal" style="flex: 1; background: linear-gradient(135deg, #6c757d 0%, #495057 100%);" onclick="closeDetailsModal()">Tancar</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n para campos incompletos -->
    <div class="confirm-modal" id="confirmModal" style="display: none;">
        <div class="confirm-content">
            <h3>‚ö†Ô∏è Camps incomplets</h3>
            <p>Falten els seg√ºents camps per emplenar:</p>
            <ul id="missingFieldsList" style="text-align: left; margin: 15px 0; color: #d32f2f;"></ul>
            <p style="margin-top: 15px;">Vols completar-los ara o guardar igualment?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="confirm-btn confirm-btn-secondary" onclick="closeConfirmModal()">Completar ara</button>
                <button class="confirm-btn confirm-btn-primary" onclick="saveAnywayConfirmed()">Guardar igualment</button>
            </div>
        </div>
    </div>

    <!-- Cliente Supabase (reemplaza Google Apps Script) -->
    <script src="supabase-client.js"></script>

    <script>
        // Sistema de contrase√±a con hash SHA-256
    
        const correctPasswordHash = "8505c821e124e939f3342d2cd2a1d8d2694f395d217284ed4d9fcdbd11ed25f0";

        // Funci√≥n para generar hash SHA-256
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Funci√≥n para verificar la contrase√±a
        async function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            const passwordHash = await hashPassword(password);

            if (passwordHash === correctPasswordHash) {
                // Generar token de sesi√≥n √∫nico
                const sessionToken = btoa(Date.now() + Math.random().toString(36));
                localStorage.setItem('victorCatalaAuth', sessionToken);
                localStorage.setItem('victorCatalaAuthTime', Date.now().toString());
                document.getElementById('passwordModal').style.display = 'none';
                document.querySelector('.mainContent').classList.remove('hidden');
                document.getElementById('chat-toggle').style.display = 'flex';
                initializeApp();
            } else {
                alert('Contrassenya incorrecta. Si us plau, intenta-ho novament.');
                document.getElementById('passwordInput').value = '';
            }
        }

        // Funci√≥n para verificar si la sesi√≥n es v√°lida (expira despu√©s de 24 horas)
        function isSessionValid() {
            const authToken = localStorage.getItem('victorCatalaAuth');
            const authTime = localStorage.getItem('victorCatalaAuthTime');

            if (!authToken || !authTime) return false;

            const currentTime = Date.now();
            const sessionAge = currentTime - parseInt(authTime);
            const maxSessionAge = 24 * 60 * 60 * 1000; // 24 horas

            return sessionAge < maxSessionAge;
        }

        // Base de datos de aniversarios (se carga din√°micamente desde Supabase)
        const dadesAniversaris = [];

        // Frases motivadoras para cada mes
        const frasesMotivadores = [
            "üéä Any nou, nous desitjos! Comencem amb energia!", // Gener
            "üíï Febrer, el mes de l'amor i l'amistat!", // Febrer
            "üå∏ Primavera arriba, celebrem la vida!", // Mar√ß
            "üåßÔ∏è Abril, aig√ºes mil... i aniversaris tamb√©!", // Abril
            "üå∫ Maig floreix, i nosaltres tamb√©!", // Maig
            "‚òÄÔ∏è Comen√ßa l'estiu, celebrem junts!", // Juny
            "üéâ Juliol de vacances i alegria!", // Juliol
            "üåû Agost, sol i amistats que duren!", // Agost
            "üçÇ Tardor de somriures i records!", // Setembre
            "üéÉ Octubre, castanyada i celebracions!", // Octubre
            "üçÅ Novembre, temps de records i gratitud!", // Novembre
            "üéÑ Nadal arriba, celebrem amb il¬∑lusi√≥!" // Desembre
        ];

        // ============================================
        // API SUPABASE (cargado desde supabase-client.js)
        // Las funciones fetchBirthdays, addBirthdayToSheet,
        // addBirthdayToSheetForzado, updateBirthdayInSheet,
        // deleteBirthdayFromSheet, sendBirthdayEmailsManually,
        // sendBirthdaySMSManually, showMaintenanceMode y
        // showSyncMessage est√°n definidas en supabase-client.js
        // ============================================

        let chart;

        function getDiesMes(mes, any = 2025) {
            return new Date(any, mes, 0).getDate();
        }

        function getRandomColor() {
            const r = Math.floor(Math.random() * 200 + 55);
            const g = Math.floor(Math.random() * 200 + 55);
            const b = Math.floor(Math.random() * 200 + 55);
            return `rgba(${r}, ${g}, ${b}, 0.6)`;
        }

        function actualitzarGrafic(mes) {
            // Filtrar por mes y por b√∫squeda
            let aniversarisMes;

            if (currentSearchTerm) {
                aniversarisMes = searchBirthdays(currentSearchTerm).filter(d => d.mes === parseInt(mes));
            } else {
                aniversarisMes = dadesAniversaris.filter(d => d.mes === parseInt(mes));
            }

            aniversarisMes.sort((a, b) => a.dia - b.dia);

            // Actualizar estad√≠sticas
            updateMonthStats(mes);

            const chartContainer = document.getElementById('chartContainer');
            const canvas = document.getElementById('aniversarisChart');

            // Si no existe chartContainer, significa que no estamos en vista de gr√°fico
            if (!chartContainer) {
                console.log('No se puede actualizar gr√°fico: no estamos en vista de gr√°fico');
                return;
            }

            // Mostrar empty state si no hay resultados
            if (aniversarisMes.length === 0) {
                if (chart) chart.destroy();
                chartContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéÇ</div>
                        <div class="empty-state-text">No s'han trobat aniversaris${currentSearchTerm ? ' amb aquesta cerca' : ' aquest mes'}</div>
                    </div>
                `;
                return;
            }

            // Restaurar canvas si fue eliminado
            if (!canvas) {
                chartContainer.innerHTML = '<canvas id="aniversarisChart"></canvas>';
            }

            // A√±adir animaci√≥n
            chartContainer.classList.add('chart-transition');
            setTimeout(() => chartContainer.classList.remove('chart-transition'), 500);

            const diesMes = getDiesMes(mes);
            const mostrarTelefons = document.getElementById('mostrarTelefons').checked;

            const data = {
                labels: aniversarisMes.map(d => {
                    if (mostrarTelefons && d.telefon && d.telefon.trim() !== "") {
                        return `${d.dia} - ${d.nom} (${d.telefon})`;
                    } else {
                        return `${d.dia} - ${d.nom}`;
                    }
                }),
                datasets: [{
                    label: 'Dia de l\'aniversari',
                    data: aniversarisMes.map(d => d.dia),
                    backgroundColor: aniversarisMes.map(() => getRandomColor()),
                    borderColor: 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 1
                }]
            };

            if (chart) {
                chart.destroy();
            }

            const ctx = document.getElementById('aniversarisChart').getContext('2d');

            // Registrar el plugin de datalabels
            Chart.register(ChartDataLabels);

            chart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const persona = aniversarisMes[index];
                            showBirthdayDetails(persona);
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: diesMes,
                            title: {
                                display: true,
                                text: 'Dia del mes'
                            }
                        },
                        y: {
                            ticks: {
                                autoSkip: false,
                                font: {
                                    size: function(context) {
                                        const width = window.innerWidth;
                                        return width < 768 ? 10 : 12;
                                    }
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Aniversaris ${getPrefixForMonth(mes)}${getMesName(mes)}`,
                            font: {
                                size: function(context) {
                                    const width = window.innerWidth;
                                    return width < 768 ? 14 : 16;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            anchor: 'start',
                            align: 'end',
                            formatter: function(value, context) {
                                return value;
                            },
                            font: {
                                weight: 'bold',
                                size: function(context) {
                                    const width = window.innerWidth;
                                    return width < 768 ? 10 : 12;
                                }
                            },
                            color: 'black',
                            offset: 4
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Click per veure detalls';
                                }
                            }
                        }
                    }
                }
            });
        }

        function getMesName(mesNumber) {
            const mesos = ["", "Gener", "Febrer", "Mar√ß", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];
            return mesos[parseInt(mesNumber)] || 'Mes desconegut';
        }

        function getPrefixForMonth(mesNumber) {
            const mesos = ["", "Gener", "Febrer", "Mar√ß", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];
            const mesNom = mesos[parseInt(mesNumber)] || '';
            const primeraLletra = mesNom.charAt(0).toLowerCase();

            if (['a', 'e', 'i', 'o', 'u'].includes(primeraLletra)) {
                return "d'";
            } else {
                return "de ";
            }
        }

        function getFormattedToday() {
            const hoy = new Date();
            const dia = hoy.getDate();
            const mesNumber = hoy.getMonth() + 1;
            const mes = getMesName(mesNumber);
            const any = hoy.getFullYear();
            const prefix = getPrefixForMonth(mesNumber);
            return `Avui √©s ${dia} ${prefix}${mes} de ${any}`;
        }

        function getPrefixForName(nom) {
            const primeraLletra = nom.charAt(0).toLowerCase();
            return ['a','e','i','o','u','√†','√®','√©','√≠','√≤','√≥','√∫'].includes(primeraLletra) ? "d'" : "de ";
        }

        function joinNamesCatalan(noms) {
            if (noms.length === 1) return noms[0];
            if (noms.length === 2) return `${noms[0]} i ${noms[1]}`;
            return noms.slice(0, -1).join(", ") + " i " + noms[noms.length - 1];
        }

        function getNextBirthdays() {
            const today = new Date();
            const currentYear = today.getFullYear();

            // Filtrar solo personas con d√≠a y mes v√°lidos
            const proxims = dadesAniversaris
                .filter(d => d.dia && d.mes && !isNaN(d.dia) && !isNaN(d.mes))
                .map(d => {
                    const cumple = new Date(currentYear, d.mes - 1, d.dia);
                    const fecha = (cumple < today) ? new Date(currentYear + 1, d.mes - 1, d.dia) : cumple;
                    return { nom: d.nom, dia: d.dia, mes: d.mes, fecha };
                })
                .sort((a, b) => a.fecha - b.fecha);

            return proxims.slice(0, 2);
        }


        // Funci√≥n auxiliar para calcular el a√±o correcto seg√∫n el mes seleccionado
        function getYearForMonth(selectedMonth) {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            // Si el mes seleccionado ya pas√≥, mostrar el a√±o siguiente
            return selectedMonth < currentMonth ? currentYear + 1 : currentYear;
        }

        // Funci√≥n para mostrar pr√≥ximo cumplea√±os y recordatorio
        function updateUpcomingBirthdays() {
            const upcomingList = document.getElementById('upcomingList');
            [nextBday, secondBday] = getNextBirthdays();

            const now = new Date();
            const hoyTexto = getFormattedToday();
            const diff = nextBday ? (nextBday.fecha - now) : 0;

            const cumpleHoy = dadesAniversaris.filter(d => d.dia && d.mes && d.dia === now.getDate() && d.mes === (now.getMonth() + 1));
            let hoyMsg = `<div style="font-size: 0.95rem; margin-bottom: 2px; text-align: center;">üìÖ <strong class="glow-text">${hoyTexto}</strong></div>`;

            if (cumpleHoy.length > 0) {
                const nomsArr = cumpleHoy.map(d => d.nom);
                const nomsFormatats = joinNamesCatalan(nomsArr);

                // Determinar si todas las personas est√°n fallecidas
                const todasFallecidas = cumpleHoy.every(p => p.viu === 'No');
                const texto = todasFallecidas ? 'Avui va n√©ixer' : `Avui √©s l'aniversari ${getPrefixForName(nomsArr[0])}`;

                hoyMsg += `<div style="font-size: 1.1rem; margin-top: 3px; text-align: center;">${todasFallecidas ? 'üïäÔ∏è' : 'üéÇ'} ${texto}<strong>${nomsFormatats}</strong></div>`;

                // Mostrar edad o a√±o de nacimiento
                cumpleHoy.forEach(persona => {
                    if (persona.anyNaixement) {
                        const currentYear = now.getFullYear();
                        const age = currentYear - persona.anyNaixement;

                        // Si la persona NO est√° viva, mostrar a√±o de nacimiento
                        if (persona.viu === 'No') {
                            const nascut = persona.genere === 'D' ? 'Nascuda' : 'Nascut';
                            hoyMsg += `<div style="font-size: 1rem; margin-top: 2px; text-align: center; opacity: 0.95;">üïäÔ∏è ${nascut} el <strong>${persona.anyNaixement}</strong></div>`;
                        } else {
                            // Si est√° viva, mostrar edad
                            const verb = cumpleHoy.length === 1 ? 'fa' : `${persona.nom.split(' ')[0]} fa`;
                            hoyMsg += `<div style="font-size: 1rem; margin-top: 2px; text-align: center; opacity: 0.95;">üéÇ ${cumpleHoy.length === 1 ? 'Fa' : verb} <strong>${age} anys</strong> avui</div>`;
                        }
                    }
                });
            }

            if (!nextBday) {
                upcomingList.innerHTML = hoyMsg;
                return;
            }

            if (diff <= 0) {
                // Si hay cumplea√±os hoy, ya se muestra en hoyMsg, no duplicar
                upcomingList.innerHTML = hoyMsg;
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            // Buscar persona completa para obtener anyNaixement y estado
            const nextPerson = dadesAniversaris.find(d => d.nom === nextBday.nom && d.dia === nextBday.dia && d.mes === nextBday.mes);
            let ageText = '';
            if (nextPerson && nextPerson.anyNaixement) {
                const nextBirthdayYear = nextBday.fecha.getFullYear();
                const age = nextBirthdayYear - nextPerson.anyNaixement;

                // Si la persona NO est√° viva, mostrar a√±o de nacimiento
                if (nextPerson.viu === 'No') {
                    const nascut = nextPerson.genere === 'D' ? 'Nascuda' : 'Nascut';
                    ageText = `<div style="font-size: 1rem; margin-top: 2px; opacity: 0.95;">üïäÔ∏è ${nascut} el <strong>${nextPerson.anyNaixement}</strong></div>`;
                } else {
                    ageText = `<div style="font-size: 1rem; margin-top: 2px; opacity: 0.95;">üéÇ Far√† <strong>${age} anys</strong></div>`;
                }
            }

            const secondLine = "";

            upcomingList.innerHTML = `
                ${hoyMsg}
                <div style="margin: 6px 0; text-align: center;">
                    <div class="glow-text" style="font-size: 1.05rem; margin-bottom: 2px;">üéâ Pr√≤xim aniversari:</div>
                    <div style="font-size: 1.2rem; font-weight: 700; margin: 2px 0;"><strong>${nextBday.nom}</strong></div>
                    <div style="font-size: 0.9rem; margin-top: 2px; opacity: 0.95;">${nextBday.dia} ${getMesName(nextBday.mes)}</div>
                    ${ageText}
                    <div class="pulse-counter" style="font-size: 1.4rem; margin-top: 5px; font-weight: 700; display: inline-block;">‚è≥ ${days} dies, ${hours}h ${minutes}m ${seconds}s</div>
                </div>
                ${secondLine}
            `;
        }

        // Funci√≥n para actualizar estad√≠sticas del mes
        function updateMonthStats(mes) {
            const aniversarisMes = dadesAniversaris.filter(d => d.mes === parseInt(mes));

            // Tarjeta izquierda: Mes + Frase motivadora
            const statMonth = document.getElementById('statMonth');
            const statMotivation = document.getElementById('statMotivation');

            statMonth.textContent = getMesName(parseInt(mes));
            statMotivation.textContent = frasesMotivadores[parseInt(mes) - 1];

            // Tarjeta derecha: Lista de todos los aniversarios del mes
            const statBirthdayList = document.getElementById('statBirthdayList');

            if (aniversarisMes.length === 0) {
                statBirthdayList.innerHTML = '<span style="color: #999;">Cap aniversari</span>';
            } else {
                // Ordenar por d√≠a
                const sorted = aniversarisMes.sort((a, b) => a.dia - b.dia);
                statBirthdayList.innerHTML = sorted.map(b =>
                    `<div style="margin-bottom: 5px;">
                        <strong>${b.dia}</strong> - ${b.nom}
                    </div>`
                ).join('');
            }
        }

        // Variables para b√∫squeda y filtrado
        let filteredData = [];
        let currentSearchTerm = '';

        /**
         * Formatear display de cumplea√±os seg√∫n estado viu
         * Para fallecidos: a√±os con paloma (nacimiento) y cruz (muerte)
         * Para vivos: fecha completa
         */
        function formatBirthdayDisplay(person) {
            if (person.viu === 'No') {
                // Fallecido - solo a√±os
                if (person.anyMort) {
                    return `${person.anyNaixement || '?'} - ${person.anyMort} ‚úù`;
                } else if (person.anyNaixement) {
                    return `${person.anyNaixement}`;
                } else {
                    return '‚úù';
                }
            } else {
                // Vivo - fecha completa
                const birthday = person.anyNaixement
                    ? `${person.dia}/${person.mes}/${person.anyNaixement}`
                    : `${person.dia}/${person.mes}`;
                return birthday;
            }
        }

        /**
         * Calcular edad actual correcta
         * Tiene en cuenta si ya ha cumplido a√±os este a√±o
         */
        function calculateAge(person) {
            if (!person.anyNaixement) return null;
            const today = new Date();
            const currentYear = today.getFullYear();
            const birthdayThisYear = new Date(currentYear, person.mes - 1, person.dia);
            return currentYear - person.anyNaixement - (today < birthdayThisYear ? 1 : 0);
        }

        // Funci√≥n de b√∫squeda
        function searchBirthdays(searchTerm) {
            currentSearchTerm = searchTerm.toLowerCase();

            if (!currentSearchTerm) {
                filteredData = [];
                return dadesAniversaris;
            }

            filteredData = dadesAniversaris.filter(d =>
                d.nom.toLowerCase().includes(currentSearchTerm)
            );

            return filteredData;
        }

        // Funci√≥n para mostrar detalles en modal
        function showBirthdayDetails(persona) {
            const modal = document.getElementById('detailsModal');
            const today = new Date();
            const currentYear = today.getFullYear();
            const birthdayThisYear = new Date(currentYear, persona.mes - 1, persona.dia);
            const birthdayDate = birthdayThisYear < today ?
                new Date(currentYear + 1, persona.mes - 1, persona.dia) : birthdayThisYear;

            const daysUntil = Math.floor((birthdayDate - today) / (1000 * 60 * 60 * 24));

            // Guardar persona actual para edici√≥n
            currentEditingPerson = persona;

            // Display seg√∫n estado viu
            const dateDisplay = formatBirthdayDisplay(persona);
            const dateLabel = persona.viu === 'No' ? 'üïäÔ∏è Anys' : 'üìÖ Data';
            document.getElementById('detailsDate').parentElement.innerHTML =
                `<strong>${dateLabel}:</strong> <span id="detailsDate">${dateDisplay}</span>`;

            // Mostrar edad solo para vivos
            const ageContainer = document.getElementById('detailsAgeContainer');
            if (persona.anyNaixement && persona.viu !== 'No') {
                const currentAge = currentYear - persona.anyNaixement - (today < birthdayThisYear ? 1 : 0);
                document.getElementById('detailsAge').textContent = `${currentAge} anys`;
                ageContainer.style.display = 'block';
            } else {
                ageContainer.style.display = 'none';
            }

            // Mostrar lugar de nacimiento si existe
            const birthplaceContainer = ageContainer.parentElement.querySelector('.birthplace-info') || createBirthplaceElement();
            if (persona.llocNaixement) {
                birthplaceContainer.querySelector('span').textContent = persona.llocNaixement;
                birthplaceContainer.style.display = 'block';
            } else {
                birthplaceContainer.style.display = 'none';
            }

            function createBirthplaceElement() {
                const detailsContent = document.querySelector('.details-content');
                const birthplaceDiv = document.createElement('div');
                birthplaceDiv.className = 'details-info birthplace-info';
                birthplaceDiv.innerHTML = '<strong>üìç Lloc de naixement:</strong> <span></span>';
                ageContainer.parentElement.insertBefore(birthplaceDiv, ageContainer.nextSibling);
                return birthplaceDiv;
            }

            // Mostrar email i tel√®fon nom√©s per persones vives
            if (persona.viu !== 'No') {
                document.getElementById('detailsPhone').parentElement.innerHTML = `<strong>üìû Tel√®fon:</strong> <span id="detailsPhone">${persona.telefon || 'No disponible'}</span>`;
                document.getElementById('detailsEmail').parentElement.innerHTML = `<strong>üìß Email:</strong> <span id="detailsEmail">${persona.email || 'No disponible'}</span>`;
                document.getElementById('detailsPhone').parentElement.style.display = 'block';
                document.getElementById('detailsEmail').parentElement.style.display = 'block';
            } else {
                document.getElementById('detailsPhone').parentElement.style.display = 'none';
                document.getElementById('detailsEmail').parentElement.style.display = 'none';
            }

            // Mostrar dies fins aniversari nom√©s per persones vives
            if (persona.viu !== 'No') {
                document.getElementById('detailsDays').parentElement.style.display = 'block';
                document.getElementById('detailsDays').parentElement.innerHTML = `<strong>‚è∞ Dies fins al pr√≤xim aniversari:</strong> <span id="detailsDays">${daysUntil === 0 ? 'Avui!' : daysUntil + ' dies'}</span>`;
            } else {
                document.getElementById('detailsDays').parentElement.style.display = 'none';
            }

            document.getElementById('detailsName').textContent = persona.nom;

            // Mostrar informaci√≥n de relaciones familiares
            const familyInfoHtml = buildFamilyInfoHtml(persona);
            const detailsContent = document.querySelector('.details-content');
            let existingFamilyInfo = document.getElementById('familyRelationsInfo');

            if (existingFamilyInfo) {
                existingFamilyInfo.remove();
            }

            if (familyInfoHtml) {
                const familyDiv = document.createElement('div');
                familyDiv.id = 'familyRelationsInfo';
                familyDiv.style.cssText = 'margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;';
                familyDiv.innerHTML = familyInfoHtml;

                const buttonsContainer = detailsContent.querySelector('.details-buttons');
                if (buttonsContainer) {
                    detailsContent.insertBefore(familyDiv, buttonsContainer);
                } else {
                    detailsContent.appendChild(familyDiv);
                }
            }

            modal.classList.add('show');
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('show');
        }

        // Funci√≥n para toggle de modo oscuro
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
        }

        // ============================================
        // M√ìDULO DE √ÅRBOL GENEAL√ìGICO
        // ============================================

        // Variables globales para D3.js
        let familyTreeSvg, familyTreeG, familyTreeZoom;

        /**
         * Mostrar spinner de carga en el contenedor del √°rbol
         */
        function showLoadingSpinner(container) {
            const existing = container.querySelector('.tree-loading');
            if (existing) return;

            const spinner = document.createElement('div');
            spinner.className = 'tree-loading';
            spinner.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                color: #667eea;
                font-size: 1.2rem;
            `;
            spinner.innerHTML = `
                <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                <div>Carregant arbre familiar...</div>
            `;
            container.insertBefore(spinner, container.firstChild);
        }

        /**
         * Abrir modal del √°rbol geneal√≥gico
         */
        async function openFamilyTree() {
            const modal = document.getElementById('familyTreeModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            // Limpiar buscador al abrir
            const treeSearchInput = document.getElementById('treeSearchInput');
            if (treeSearchInput) {
                treeSearchInput.value = '';
            }

            // Mostrar loading spinner mientras se cargan datos
            const container = document.getElementById('familyTreeContainer');
            showLoadingSpinner(container);

            // Esperar a que datos est√©n cargados
            if (dadesAniversaris.length === 0) {
                await loadDataFromStorage();
            }

            // Siempre mostrar vista de lista
            setTimeout(() => {
                renderFamilyList();

                // Agregar event listener al buscador del √°rbol
                setupTreeSearch();
            }, 50);
        }

        /**
         * Cerrar modal del √°rbol geneal√≥gico
         */
        function closeFamilyTree() {
            const modal = document.getElementById('familyTreeModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';

            // Resetear flag del buscador para permitir re-configuraci√≥n
            treeSearchListenerAdded = false;
        }

        /**
         * Configurar buscador del √°rbol geneal√≥gico
         */
        let treeSearchListenerAdded = false;
        let searchBlurTimeout;
        function setupTreeSearch() {
            const treeSearchInput = document.getElementById('treeSearchInput');
            const treeSearchClear = document.getElementById('treeSearchClear');
            if (!treeSearchInput) return;

            // Solo agregar el event listener una vez
            if (treeSearchListenerAdded) return;

            // Funci√≥n para filtrar tarjetas
            const filterCards = (searchTerm) => {
                const cards = document.querySelectorAll('.family-list-card');

                if (!searchTerm) {
                    // Mostrar todas las tarjetas
                    cards.forEach(card => {
                        card.style.display = 'flex';
                    });
                    // Ocultar bot√≥n de limpiar
                    if (treeSearchClear) {
                        treeSearchClear.classList.remove('show');
                    }
                    return;
                }

                // Mostrar bot√≥n de limpiar
                if (treeSearchClear) {
                    treeSearchClear.classList.add('show');
                }

                // Filtrar tarjetas por nombre
                cards.forEach(card => {
                    const nameElement = card.querySelector('.family-list-name');
                    if (nameElement) {
                        const name = nameElement.textContent.toLowerCase();
                        if (name.includes(searchTerm)) {
                            card.style.display = 'flex';
                        } else {
                            card.style.display = 'none';
                        }
                    }
                });
            };

            treeSearchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                filterCards(searchTerm);

                // Cerrar teclado autom√°ticamente despu√©s de buscar (m√≥vil/tablet)
                clearTimeout(searchBlurTimeout);
                searchBlurTimeout = setTimeout(() => {
                    if (searchTerm) {
                        treeSearchInput.blur();
                    }
                }, 1500); // Esperar 1500ms despu√©s de dejar de escribir
            });

            // Bot√≥n de limpiar b√∫squeda
            if (treeSearchClear) {
                treeSearchClear.addEventListener('click', function() {
                    treeSearchInput.value = '';
                    filterCards('');
                    treeSearchInput.focus();
                });
            }

            treeSearchListenerAdded = true;
        }

        /**
         * Poblar dropdowns de relaciones familiares
         */
        function populateFamilyDropdowns(excludeRowNumber = null) {
            const pareSelect = document.getElementById('formPare');
            const mareSelect = document.getElementById('formMare');
            const parellaSelect = document.getElementById('formParella');

            // Limpiar opciones existentes
            pareSelect.innerHTML = '<option value="">No especificat</option>';
            mareSelect.innerHTML = '<option value="">No especificat</option>';
            parellaSelect.innerHTML = '<option value="">No especificat</option>';

            // Filtrar todas las personas (incluyendo fallecidas) y ordenar por nombre
            const allPeople = dadesAniversaris
                .filter(p => p.rowNumber !== excludeRowNumber)
                .sort((a, b) => a.nom.localeCompare(b.nom, 'ca'));

            // Poblar Pare (solo hombres)
            allPeople.filter(p => p.genere === 'H').forEach(p => {
                const option = document.createElement('option');
                option.value = p.rowNumber;
                const calculatedAge = calculateAge(p);
                const age = (p.viu !== 'No' && calculatedAge) ? ` (${calculatedAge} anys)` : '';
                const deceased = p.viu === 'No' ? ' üïäÔ∏è' : '';
                option.textContent = `${p.nom}${age}${deceased}`;
                pareSelect.appendChild(option);
            });

            // Poblar Mare (solo mujeres)
            allPeople.filter(p => p.genere === 'D').forEach(p => {
                const option = document.createElement('option');
                option.value = p.rowNumber;
                const calculatedAge = calculateAge(p);
                const age = (p.viu !== 'No' && calculatedAge) ? ` (${calculatedAge} anys)` : '';
                const deceased = p.viu === 'No' ? ' üïäÔ∏è' : '';
                option.textContent = `${p.nom}${age}${deceased}`;
                mareSelect.appendChild(option);
            });

            // Poblar Parella (todos)
            allPeople.forEach(p => {
                const option = document.createElement('option');
                option.value = p.rowNumber;
                const icon = p.genere === 'H' ? 'üë®' : p.genere === 'D' ? 'üë©' : '';
                const calculatedAge = calculateAge(p);
                const age = (p.viu !== 'No' && calculatedAge) ? ` (${calculatedAge} anys)` : '';
                const deceased = p.viu === 'No' ? ' üïäÔ∏è' : '';
                option.textContent = `${icon} ${p.nom}${age}${deceased}`;
                parellaSelect.appendChild(option);
            });
        }

        /**
         * Construir estructura jer√°rquica para D3.js
         */
        function buildFamilyHierarchy() {
            // 1. Crear mapa de personas por rowNumber
            const peopleMap = new Map();
            dadesAniversaris.forEach(person => {
                peopleMap.set(person.rowNumber, {
                    ...person,
                    children: []
                });
            });

            // 2. NUEVO: Detectar parejas con hijos comunes y crear nodos de uni√≥n
            const coupleUnions = new Map(); // key: "pareId-mareId"
            const childrenAssigned = new Set(); // Rastrear hijos asignados a uniones

            dadesAniversaris.forEach(person => {
                const hasPare = person.pareId && peopleMap.has(person.pareId);
                const hasMare = person.mareId && peopleMap.has(person.mareId);

                // Si tiene AMBOS padres, es hijo com√∫n de una pareja
                if (hasPare && hasMare) {
                    const coupleKey = `${person.pareId}-${person.mareId}`;

                    // Crear nodo de uni√≥n si no existe
                    if (!coupleUnions.has(coupleKey)) {
                        const pare = peopleMap.get(person.pareId);
                        const mare = peopleMap.get(person.mareId);

                        coupleUnions.set(coupleKey, {
                            isCoupleUnion: true,
                            coupleKey: coupleKey,
                            pareId: person.pareId,
                            mareId: person.mareId,
                            pareName: pare.nom,
                            mareName: mare.nom,
                            children: [],
                            virtual: true,
                            nom: 'üíë'
                        });
                    }

                    // Agregar hijo al nodo de uni√≥n
                    coupleUnions.get(coupleKey).children.push(
                        peopleMap.get(person.rowNumber)
                    );
                    childrenAssigned.add(person.rowNumber);
                }
            });

            // 3. Construir jerarqu√≠a principal (SOLO hijos NO comunes)
            const roots = [];

            dadesAniversaris.forEach(person => {
                // Saltar si ya fue asignado como hijo com√∫n
                if (childrenAssigned.has(person.rowNumber)) {
                    return;
                }

                const hasPare = person.pareId && peopleMap.has(person.pareId);
                const hasMare = person.mareId && peopleMap.has(person.mareId);

                if (!hasPare && !hasMare) {
                    // Es una ra√≠z
                    roots.push(peopleMap.get(person.rowNumber));
                } else {
                    // Agregar como hijo del padre o madre (solo un padre conocido)
                    if (hasPare) {
                        peopleMap.get(person.pareId).children.push(
                            peopleMap.get(person.rowNumber)
                        );
                    } else if (hasMare) {
                        peopleMap.get(person.mareId).children.push(
                            peopleMap.get(person.rowNumber)
                        );
                    }
                }
            });

            // 4. NUEVO: Insertar nodos de uni√≥n en la jerarqu√≠a
            coupleUnions.forEach((coupleNode) => {
                const pare = peopleMap.get(coupleNode.pareId);
                const mare = peopleMap.get(coupleNode.mareId);

                // Agregar nodo de uni√≥n como hijo del padre
                pare.children.push(coupleNode);

                // Guardar referencia a la madre para renderizado de enlace de pareja
                coupleNode.partnerNode = mare;
            });

            // 5. Retornar ra√≠z √∫nica o nodo virtual
            if (roots.length === 0 && dadesAniversaris.length > 0) {
                return {
                    nom: 'Fam√≠lia',
                    virtual: true,
                    children: Array.from(peopleMap.values()).filter(p =>
                        !p.pareId && !p.mareId && !childrenAssigned.has(p.rowNumber)
                    )
                };
            }

            if (roots.length === 1) {
                return roots[0];
            }

            return {
                nom: 'Fam√≠lia',
                virtual: true,
                children: roots
            };
        }

        /**
         * Obtener iniciales de un nombre
         */
        function getInitials(name) {
            if (!name) return '??';
            const parts = name.trim().split(' ');
            if (parts.length === 1) {
                return parts[0].substring(0, 2).toUpperCase();
            }
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }

        /**
         * Renderizar √°rbol geneal√≥gico con D3.js
         */
        function renderFamilyTree() {
            const container = document.getElementById('familyTreeContainer');

            // Limpiar spinner de carga
            const spinner = container.querySelector('.tree-loading');
            if (spinner) spinner.remove();

            // Limpiar SVG anterior (pero mantener controles y leyenda)
            const existingSvg = container.querySelector('svg');
            if (existingSvg) {
                existingSvg.remove();
            }

            // Si no hay datos, mostrar mensaje
            if (dadesAniversaris.length === 0) {
                const message = document.createElement('div');
                message.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    text-align: center;
                    color: #6c757d;
                    font-size: 1.2rem;
                `;
                message.innerHTML = `
                    <div style="font-size: 4rem; margin-bottom: 20px;">üå≥</div>
                    <div>No hi ha dades per mostrar l'arbre familiar</div>
                `;
                container.insertBefore(message, container.firstChild);
                return;
            }

            // Dimensiones
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Crear SVG
            familyTreeSvg = d3.select('#familyTreeContainer')
                .insert('svg', ':first-child')
                .attr('width', width)
                .attr('height', height);

            // Configurar zoom
            familyTreeZoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .filter(function(event) {
                    // Detectar si el touch es sobre un nodo
                    const isTouchOnNode = event.target.closest('.tree-node');

                    if (isTouchOnNode) {
                        // Solo permitir pinch zoom (2+ dedos) en nodos, bloquear pan
                        return event.type === 'wheel' ||
                               (event.type === 'touchstart' && event.touches && event.touches.length > 1);
                    }

                    // Permitir todos los gestos zoom en el fondo
                    return true;
                })
                .on('zoom', (event) => {
                    familyTreeG.attr('transform', event.transform);
                });

            familyTreeSvg.call(familyTreeZoom);

            // Grupo principal
            familyTreeG = familyTreeSvg.append('g');

            // Construir jerarqu√≠a
            const hierarchyData = buildFamilyHierarchy();
            const root = d3.hierarchy(hierarchyData);

            // Detecci√≥n de tipo de dispositivo
            const isMobile = width <= 768;
            const isTablet = width > 768 && width <= 1024;
            const isVerticalLayout = isMobile && width < 600;

            let xOffset, yOffset;

            if (isVerticalLayout) {
                // Layout VERTICAL (top-to-bottom) para m√≥vil peque√±o
                const treeLayout = d3.tree()
                    .size([width * 0.9, height * 0.85])
                    .separation((a, b) => (a.parent === b.parent ? 1.8 : 2.2));

                treeLayout(root);

                xOffset = 20;
                yOffset = 50;
            } else {
                // Layout HORIZONTAL (left-to-right) para desktop/tablet
                const horizontalOffset = isMobile ? width * 0.1 : width * 0.15;
                const verticalOffset = isMobile ? height * 0.05 : height * 0.1;

                // Separaci√≥n aumentada en m√≥vil para touch targets
                const siblingSeparation = isMobile ? 3 : 2;
                const cousinSeparation = isMobile ? 4 : 2.5;

                const treeLayout = d3.tree()
                    .size([height - verticalOffset * 2, width - horizontalOffset * 2])
                    .separation((a, b) => {
                        return (a.parent === b.parent ? siblingSeparation : cousinSeparation);
                    });

                treeLayout(root);

                xOffset = isMobile ? 50 : 150;
                yOffset = isMobile ? 30 : 75;
            }

            // NUEVO: Ajustar posiciones de madres para que est√©n al mismo nivel que padres
            root.descendants().forEach(node => {
                if (node.data.isCoupleUnion) {
                    // Este es un nodo de uni√≥n
                    const pareNode = node.parent; // El padre del nodo de uni√≥n
                    const mareNode = root.descendants().find(
                        d => d.data.rowNumber === node.data.mareId
                    );

                    if (pareNode && mareNode) {
                        // Ajustar la posici√≥n vertical (x en D3 tree) para que est√© al mismo nivel
                        mareNode.x = pareNode.x;
                        // Ajustar posici√≥n horizontal (y en D3 tree) para que est√© cerca
                        mareNode.y = pareNode.y + 50; // Un poco a la derecha del padre
                    }
                }
            });

            // NUEVO: Restaurar posiciones personalizadas guardadas
            const savedPositions = loadNodePositions();
            root.descendants().forEach(node => {
                if (node.data.rowNumber && savedPositions[node.data.rowNumber]) {
                    node.x = savedPositions[node.data.rowNumber].x;
                    node.y = savedPositions[node.data.rowNumber].y;
                }
            });

            // NUEVO: Separar enlaces normales y de pareja
            const normalLinks = [];
            const partnerLinks = [];

            root.links().forEach(link => {
                if (link.target.data.isCoupleUnion) {
                    normalLinks.push(link);

                    // Crear enlace de pareja a la madre
                    if (link.target.data.partnerNode) {
                        const mareNode = root.descendants().find(
                            d => d.data.rowNumber === link.target.data.mareId
                        );

                        if (mareNode) {
                            partnerLinks.push({
                                source: link.target,
                                target: mareNode,
                                isPartnerLink: true
                            });
                        }
                    }
                } else {
                    normalLinks.push(link);
                }
            });

            // Renderizar enlaces normales (padre‚Üíhijo, padre‚Üíuni√≥n)
            const linkGenerator = isVerticalLayout
                ? d3.linkVertical()
                    .x(d => d.x + xOffset)
                    .y(d => d.y + yOffset)
                : d3.linkHorizontal()
                    .x(d => d.y + xOffset)
                    .y(d => d.x + yOffset);

            familyTreeG.selectAll('.tree-link')
                .data(normalLinks)
                .enter()
                .append('path')
                .attr('class', 'tree-link')
                .attr('d', linkGenerator);

            // NUEVO: Renderizar enlaces de pareja (horizontal/vertical seg√∫n layout, punteado rosa)
            familyTreeG.selectAll('.tree-link-partner')
                .data(partnerLinks)
                .enter()
                .append('line')
                .attr('class', 'tree-link-partner')
                .attr('x1', d => isVerticalLayout ? d.source.x + xOffset : d.source.y + xOffset)
                .attr('y1', d => isVerticalLayout ? d.source.y + yOffset : d.source.x + yOffset)
                .attr('x2', d => isVerticalLayout ? d.target.x + xOffset : d.target.y + xOffset)
                .attr('y2', d => isVerticalLayout ? d.target.y + yOffset : d.target.x + yOffset);

            // Funci√≥n para actualizar enlaces cuando se arrastran nodos
            function updateLinks() {
                // Actualizar enlaces normales
                familyTreeG.selectAll('.tree-link')
                    .attr('d', linkGenerator);

                // Actualizar enlaces de pareja
                familyTreeG.selectAll('.tree-link-partner')
                    .attr('x1', d => isVerticalLayout ? d.source.x + xOffset : d.source.y + xOffset)
                    .attr('y1', d => isVerticalLayout ? d.source.y + yOffset : d.source.x + yOffset)
                    .attr('x2', d => isVerticalLayout ? d.target.x + xOffset : d.target.y + xOffset)
                    .attr('y2', d => isVerticalLayout ? d.target.y + yOffset : d.target.x + yOffset);
            }

            // Renderizar nodos
            const nodes = familyTreeG.selectAll('.tree-node')
                .data(root.descendants())
                .enter()
                .append('g')
                .attr('class', 'tree-node')
                .attr('transform', d => {
                    if (isVerticalLayout) {
                        return `translate(${d.x + xOffset}, ${d.y + yOffset})`;
                    } else {
                        return `translate(${d.y + xOffset}, ${d.x + yOffset})`;
                    }
                })
                .style('cursor', 'move')
                .call(createDragHandler(updateLinks))
                .on('click', (event, d) => {
                    // Prevenir click si acaba de hacer drag
                    if (d3.select(event.currentTarget).classed('dragging')) {
                        return;
                    }

                    // No permitir click en nodos virtuales ni nodos de uni√≥n
                    if (!d.data.virtual && !d.data.isCoupleUnion) {
                        showBirthdayDetails(d.data);
                    }
                });

            // C√≠rculos de nodos
            nodes.append('circle')
                .attr('class', d => {
                    let classes = 'tree-node-circle';
                    // NUEVO: Clase especial para nodos de uni√≥n
                    if (d.data.isCoupleUnion) {
                        classes += ' couple-union';
                    } else if (d.data.viu === 'No') {
                        classes += ' deceased';
                    } else if (d.data.genere === 'D') {
                        classes += ' female';
                    }
                    return classes;
                })
                .attr('r', d => {
                    // Aumentar tama√±o en m√≥vil para mejores touch targets
                    const isMobile = window.innerWidth <= 768;
                    const mobileFactor = isMobile ? 1.15 : 1;

                    if (d.data.isCoupleUnion) return 20 * mobileFactor;
                    if (d.data.virtual) return 25 * mobileFactor;
                    return 35 * mobileFactor;
                });

            // Iniciales en nodos
            nodes.append('text')
                .attr('class', 'tree-node-initials')
                .attr('dy', '0.35em')
                .text(d => {
                    // NUEVO: Icono üíë para nodos de uni√≥n
                    if (d.data.isCoupleUnion) return 'üíë';
                    if (d.data.virtual) return 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
                    return getInitials(d.data.nom);
                });

            // Nombres debajo de los nodos (NUEVO: NO mostrar para nodos de uni√≥n, abreviar en m√≥vil)
            nodes.filter(d => !d.data.isCoupleUnion)
                .append('text')
                .attr('class', 'tree-node-text')
                .attr('dy', '3.5em')
                .text(d => {
                    if (d.data.virtual) return d.data.nom;

                    let name = d.data.nom;

                    // Abreviar nombres largos en m√≥vil
                    if (isMobile && name.length > 15) {
                        const parts = name.split(' ');
                        name = parts[0] + (parts.length > 1 ? ' ' + parts[parts.length - 1][0] + '.' : '');
                    }

                    const deceased = d.data.viu === 'No' ? ' üïäÔ∏è' : '';
                    return name + deceased;
                });

            // A√±os de nacimiento (NUEVO: Solo para personas reales, no nodos de uni√≥n, ocultar en m√≥vil muy peque√±o)
            nodes.filter(d => {
                const isVerySmall = width < 500;
                return !d.data.virtual && !d.data.isCoupleUnion && d.data.anyNaixement && !isVerySmall;
            })
                .append('text')
                .attr('class', 'tree-node-subtext')
                .attr('dy', '5em')
                .text(d => {
                    if (d.data.viu === 'No') {
                        // Mostrar a√±o de muerte si existe, sino "?"
                        const anyMort = d.data.anyMort || '?';
                        return `(${d.data.anyNaixement} - ${anyMort} ‚úù)`;
                    }
                    const age = calculateAge(d.data);
                    return `(${age} anys)`;
                });

            // Lugar de nacimiento (NUEVO: Solo si existe, debajo de los a√±os)
            nodes.filter(d => {
                const isVerySmall = width < 500;
                return !d.data.virtual && !d.data.isCoupleUnion && d.data.llocNaixement && !isVerySmall;
            })
                .append('text')
                .attr('class', 'tree-node-subtext')
                .attr('dy', '6.5em')
                .style('font-size', '0.85em')
                .style('opacity', '0.8')
                .text(d => `üìç ${d.data.llocNaixement}`);

            // Centrar vista inicial con zoom responsive (m√°s alejado en m√≥vil peque√±o)
            const initialScale = width < 500 ? 0.25 : (isMobile ? 0.35 : (isTablet ? 0.6 : 0.8));
            const initialX = isMobile ? 10 : 100;

            const initialTransform = d3.zoomIdentity
                .translate(initialX, height / 2)
                .scale(initialScale);

            familyTreeSvg.call(familyTreeZoom.transform, initialTransform);
        }

        /**
         * Renderizar vista de lista para m√≥vil
         */
        function renderFamilyList() {
            const container = document.getElementById('familyTreeContainer');

            // Limpiar spinner y contenido anterior
            const spinner = container.querySelector('.tree-loading');
            if (spinner) spinner.remove();

            const existingSvg = container.querySelector('svg');
            if (existingSvg) existingSvg.remove();

            const existingList = container.querySelector('.family-list-view');
            if (existingList) existingList.remove();

            // Si no hay datos
            if (dadesAniversaris.length === 0) {
                const message = document.createElement('div');
                message.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    text-align: center;
                    color: #6c757d;
                    font-size: 1.2rem;
                `;
                message.innerHTML = `
                    <div style="font-size: 4rem; margin-bottom: 20px;">üë•</div>
                    <div>No hi ha dades per mostrar</div>
                `;
                container.insertBefore(message, container.firstChild);
                return;
            }

            // Crear contenedor de lista
            const listView = document.createElement('div');
            listView.className = 'family-list-view';

            // Agrupar personas: vivas primero, luego fallecidas
            const living = dadesAniversaris.filter(p => p.viu === 'S√≠');
            const deceased = dadesAniversaris.filter(p => p.viu === 'No');

            // Ordenar alfab√©ticamente
            living.sort((a, b) => a.nom.localeCompare(b.nom));
            deceased.sort((a, b) => a.nom.localeCompare(b.nom));

            // Renderizar personas vivas
            if (living.length > 0) {
                const livingGroup = document.createElement('div');
                livingGroup.className = 'family-list-group';
                livingGroup.innerHTML = `<div class="family-list-group-title">Fam√≠lia (${living.length})</div>`;

                living.forEach(person => {
                    livingGroup.appendChild(createPersonCard(person));
                });

                listView.appendChild(livingGroup);
            }

            // Renderizar personas fallecidas
            if (deceased.length > 0) {
                const deceasedGroup = document.createElement('div');
                deceasedGroup.className = 'family-list-group';
                deceasedGroup.innerHTML = `<div class="family-list-group-title">En mem√≤ria (${deceased.length})</div>`;

                deceased.forEach(person => {
                    deceasedGroup.appendChild(createPersonCard(person));
                });

                listView.appendChild(deceasedGroup);
            }

            container.insertBefore(listView, container.firstChild);
        }

        /**
         * Crear tarjeta de persona para la vista de lista
         */
        function createPersonCard(person) {
            const card = document.createElement('div');
            card.className = 'family-list-card';

            // Determinar clase de icono
            let iconClass = 'family-list-icon ';
            let iconContent = '';

            // Si tiene foto, mostrarla
            if (person.urlFoto && person.urlFoto.trim()) {
                iconClass += 'has-photo';
                iconContent = `<img src="${person.urlFoto}" alt="${person.nom}" onerror="this.style.display='none'; this.parentElement.innerHTML='${person.genere === 'H' ? 'üë®' : 'üë©'}';">`;
            } else {
                // Si no tiene foto, mostrar icono con color seg√∫n g√©nero/estado
                if (person.viu === 'No') {
                    iconClass += 'deceased';
                } else if (person.genere === 'H') {
                    iconClass += 'male';
                } else {
                    iconClass += 'female';
                }
                // Iconos m√°s distintivos
                iconContent = person.genere === 'H' ? 'üë®' : 'üë©';
            }

            // Calcular edad (solo para vivos)
            let ageInfo = '';
            if (person.anyNaixement && person.viu !== 'No') {
                const age = calculateAge(person);
                ageInfo = `${age} anys`;
            }

            const deceasedIcon = person.viu === 'No' ? ' üïäÔ∏è' : '';

            // Formato de fecha seg√∫n estado
            const birthday = formatBirthdayDisplay(person);

            card.innerHTML = `
                <div class="${iconClass}">
                    ${iconContent}
                </div>
                <div class="family-list-info">
                    <div class="family-list-name">${person.nom}${deceasedIcon}</div>
                    <div class="family-list-details">
                        üéÇ ${birthday}${ageInfo ? ' ‚Ä¢ ' + ageInfo : ''}
                    </div>
                    ${person.llocNaixement ? `<div class="family-list-details" style="opacity: 0.8; font-size: 0.9em;">üìç ${person.llocNaixement}</div>` : ''}
                </div>
            `;

            // Guardar datos de la persona en el elemento
            card.dataset.personRow = person.rowNumber;

            // Al hacer click, expandir/colapsar para mostrar relaciones
            // Diferenciar entre tap y scroll en m√≥vil
            let touchStartY = 0;
            let touchStartX = 0;
            let isTouchMove = false;

            card.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
                touchStartX = e.touches[0].clientX;
                isTouchMove = false;
            }, { passive: true });

            card.addEventListener('touchmove', (e) => {
                const deltaY = Math.abs(e.touches[0].clientY - touchStartY);
                const deltaX = Math.abs(e.touches[0].clientX - touchStartX);
                // Si se mueve m√°s de 10px, es un scroll no un tap
                if (deltaY > 10 || deltaX > 10) {
                    isTouchMove = true;
                }
            }, { passive: true });

            card.addEventListener('touchend', (e) => {
                if (!isTouchMove) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleCardExpansion(card, person);
                }
            }, { passive: false });

            card.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleCardExpansion(card, person);
            });

            return card;
        }

        /**
         * Expandir/colapsar tarjeta para mostrar relaciones
         */
        function toggleCardExpansion(card, person) {
            const isExpanded = card.classList.contains('family-card-expanded');

            // Cerrar todas las tarjetas expandidas
            document.querySelectorAll('.family-card-expanded').forEach(c => {
                c.classList.remove('family-card-expanded');
                const panel = c.querySelector('.family-relations-panel');
                if (panel) panel.remove();
            });

            // Si ya estaba expandida, solo cerrar
            if (isExpanded) {
                return;
            }

            // Expandir esta tarjeta
            card.classList.add('family-card-expanded');

            // Crear panel de relaciones
            const relationsPanel = createRelationsPanel(person);
            card.appendChild(relationsPanel);

            // Scroll suave a la tarjeta expandida
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        /**
         * Crear panel de relaciones de una persona
         */
        function createRelationsPanel(person) {
            const panel = document.createElement('div');
            panel.className = 'family-relations-panel';

            let hasRelations = false;

            // PAREJA
            if (person.parellaId) {
                const pareja = dadesAniversaris.find(p => p.rowNumber === person.parellaId);
                if (pareja) {
                    hasRelations = true;
                    let relationTitle = 'Parella';
                    if (person.estatRelacio === 'Actual') {
                        relationTitle = 'Parella (Actual)';
                    } else if (person.estatRelacio === 'Pasada') {
                        relationTitle = 'Parella (Passada)';
                    }
                    panel.appendChild(createRelationSection(relationTitle, [pareja]));
                }
            }

            // PARES (padre y madre)
            const pares = [];
            if (person.pareId) {
                const pare = dadesAniversaris.find(p => p.rowNumber === person.pareId);
                if (pare) pares.push(pare);
            }
            if (person.mareId) {
                const mare = dadesAniversaris.find(p => p.rowNumber === person.mareId);
                if (mare) pares.push(mare);
            }
            if (pares.length > 0) {
                hasRelations = true;
                panel.appendChild(createRelationSection('Pares', pares));
            }

            // GERMANS (hermanos - personas que comparten al menos un padre)
            const germans = dadesAniversaris.filter(p => {
                // No incluir a la persona misma
                if (p.rowNumber === person.rowNumber) return false;

                // Compartir el mismo padre o la misma madre
                const sharePare = person.pareId && p.pareId === person.pareId;
                const shareMare = person.mareId && p.mareId === person.mareId;

                return sharePare || shareMare;
            });
            if (germans.length > 0) {
                hasRelations = true;
                panel.appendChild(createRelationSection('Germans', germans));
            }

            // FILLS (hijos - personas que tienen este rowNumber como pare o mare)
            const fills = dadesAniversaris.filter(p =>
                p.pareId === person.rowNumber || p.mareId === person.rowNumber
            );
            if (fills.length > 0) {
                hasRelations = true;
                panel.appendChild(createRelationSection('Fills', fills));
            }

            // Si no hay relaciones
            if (!hasRelations) {
                panel.innerHTML = '<div style="text-align: center; color: #a0aec0; padding: 10px;">No hi ha relacions registrades</div>';
            }

            return panel;
        }

        /**
         * Crear secci√≥n de relaci√≥n (Pareja, Pares, Fills)
         */
        function createRelationSection(title, people) {
            const section = document.createElement('div');
            section.className = 'relation-section';

            const titleEl = document.createElement('div');
            titleEl.className = 'relation-section-title';
            titleEl.textContent = title;
            section.appendChild(titleEl);

            people.forEach(person => {
                section.appendChild(createRelationMiniCard(person));
            });

            return section;
        }

        /**
         * Crear mini-tarjeta de relaci√≥n
         */
        function createRelationMiniCard(person) {
            const miniCard = document.createElement('div');
            miniCard.className = 'relation-mini-card';

            // Determinar clase de icono
            let iconClass = 'relation-mini-icon ';
            let iconContent = '';

            // Si tiene foto, mostrarla
            if (person.urlFoto && person.urlFoto.trim()) {
                iconClass += 'has-photo';
                iconContent = `<img src="${person.urlFoto}" alt="${person.nom}" onerror="this.style.display='none'; this.parentElement.innerHTML='${person.genere === 'H' ? 'üë®' : 'üë©'}';">`;
            } else {
                // Si no tiene foto, mostrar icono con color seg√∫n g√©nero/estado
                if (person.viu === 'No') {
                    iconClass += 'deceased';
                } else if (person.genere === 'H') {
                    iconClass += 'male';
                } else {
                    iconClass += 'female';
                }
                iconContent = person.genere === 'H' ? 'üë®' : 'üë©';
            }

            const deceasedIcon = person.viu === 'No' ? ' üïäÔ∏è' : '';

            let ageInfo = '';
            if (person.anyNaixement) {
                const age = calculateAge(person);
                ageInfo = person.viu === 'No' ? `${person.anyNaixement}` : `${age} anys`;
            }

            miniCard.innerHTML = `
                <div class="${iconClass}">
                    ${iconContent}
                </div>
                <div class="relation-mini-info">
                    <div class="relation-mini-name">${person.nom}${deceasedIcon}</div>
                    <div class="relation-mini-detail">${ageInfo}</div>
                </div>
            `;

            // Al hacer click en mini-tarjeta, buscar y expandir esa tarjeta principal
            // Diferenciar entre tap y scroll en m√≥vil
            let miniTouchStartY = 0;
            let miniTouchStartX = 0;
            let isMiniTouchMove = false;

            const navigateToFamilyMember = () => {
                // Actualizar buscador del √°rbol
                const treeSearchInput = document.getElementById('treeSearchInput');
                if (treeSearchInput) {
                    treeSearchInput.value = person.nom;
                    // Disparar evento input para filtrar tarjetas
                    treeSearchInput.dispatchEvent(new Event('input'));
                }

                // Esperar a que se complete el filtrado
                setTimeout(() => {
                    const targetCard = document.querySelector(`[data-person-row="${person.rowNumber}"]`);
                    if (targetCard && targetCard.style.display !== 'none') {
                        // Scroll a la tarjeta
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Expandirla despu√©s del scroll
                        setTimeout(() => {
                            toggleCardExpansion(targetCard, person);
                        }, 300);
                    }
                }, 100);
            };

            miniCard.addEventListener('touchstart', (e) => {
                miniTouchStartY = e.touches[0].clientY;
                miniTouchStartX = e.touches[0].clientX;
                isMiniTouchMove = false;
            }, { passive: true });

            miniCard.addEventListener('touchmove', (e) => {
                const deltaY = Math.abs(e.touches[0].clientY - miniTouchStartY);
                const deltaX = Math.abs(e.touches[0].clientX - miniTouchStartX);
                // Si se mueve m√°s de 10px, es un scroll no un tap
                if (deltaY > 10 || deltaX > 10) {
                    isMiniTouchMove = true;
                }
            }, { passive: true });

            miniCard.addEventListener('touchend', (e) => {
                if (!isMiniTouchMove) {
                    e.preventDefault();
                    e.stopPropagation();
                    navigateToFamilyMember();
                }
            }, { passive: false });

            miniCard.addEventListener('click', (e) => {
                e.stopPropagation();
                navigateToFamilyMember();
            });

            return miniCard;
        }

        /**
         * Controles de zoom del √°rbol
         */
        function zoomInTree() {
            if (familyTreeSvg && familyTreeZoom) {
                familyTreeSvg.transition().duration(300).call(
                    familyTreeZoom.scaleBy, 1.3
                );
            }
        }

        function zoomOutTree() {
            if (familyTreeSvg && familyTreeZoom) {
                familyTreeSvg.transition().duration(300).call(
                    familyTreeZoom.scaleBy, 0.7
                );
            }
        }

        function resetZoomTree() {
            if (familyTreeSvg && familyTreeZoom) {
                const container = document.getElementById('familyTreeContainer');
                const width = container.clientWidth;
                const height = container.clientHeight;

                // Aplicar misma l√≥gica responsive
                const isMobile = width <= 768;
                const isTablet = width > 768 && width <= 1024;
                const resetScale = isMobile ? 0.4 : (isTablet ? 0.6 : 0.8);
                const resetX = isMobile ? 20 : 100;

                const resetTransform = d3.zoomIdentity
                    .translate(resetX, height / 2)
                    .scale(resetScale);

                familyTreeSvg.transition().duration(750).call(
                    familyTreeZoom.transform, resetTransform
                );
            }
        }

        /**
         * Resetear layout del √°rbol (borrar posiciones personalizadas)
         */
        function resetTreeLayout() {
            if (confirm('Aix√≤ reiniciar√† totes les posicions personalitzades dels nodes. Continuar?')) {
                localStorage.removeItem('familyTreePositions');
                renderFamilyList();
            }
        }

        /**
         * Alternar entre vista de √°rbol y vista de lista (solo m√≥vil)
         * NOTA: Ahora siempre muestra vista de lista con tarjetas
         */
        function toggleTreeView() {
            // Siempre mostrar vista de lista
            renderFamilyList();
            setupTreeSearch();
        }

        /**
         * Guardar posiciones personalizadas de nodos
         */
        function saveNodePositions(positions) {
            try {
                localStorage.setItem('familyTreePositions', JSON.stringify(positions));
            } catch (e) {
                console.error('Error guardant posicions:', e);
            }
        }

        /**
         * Cargar posiciones personalizadas de nodos
         */
        function loadNodePositions() {
            try {
                const saved = localStorage.getItem('familyTreePositions');
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.error('Error carregant posicions:', e);
                return {};
            }
        }

        /**
         * Crear handler de drag para nodos
         */
        function createDragHandler(updateLinks) {
            function dragStarted(event, d) {
                d3.select(this).raise().classed('dragging', true);
            }

            function dragged(event, d) {
                // Rastrear distancia de drag
                if (!this._dragDistance) this._dragDistance = 0;
                this._dragDistance += Math.abs(event.dx) + Math.abs(event.dy);

                // Actualizar posici√≥n del nodo
                d.x = event.y - 75;
                d.y = event.x - 150;

                d3.select(this).attr('transform', `translate(${event.x}, ${event.y})`);

                // Actualizar enlaces conectados
                updateLinks();
            }

            function dragEnded(event, d) {
                const wasDragged = this._dragDistance > 5; // M√°s de 5px = drag
                this._dragDistance = 0;

                if (wasDragged) {
                    // Mantener clase .dragging brevemente para bloquear click
                    d3.select(this).classed('dragging', true);
                    setTimeout(() => {
                        d3.select(this).classed('dragging', false);
                    }, 300);
                } else {
                    d3.select(this).classed('dragging', false);
                }

                // Guardar posiciones
                const positions = {};
                d3.selectAll('.tree-node').each(function(node) {
                    if (node.data.rowNumber) {
                        positions[node.data.rowNumber] = {
                            x: node.x,
                            y: node.y
                        };
                    }
                });
                saveNodePositions(positions);
            }

            return d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded);
        }

        /**
         * Construir HTML con informaci√≥n de relaciones familiares
         */
        function buildFamilyInfoHtml(persona) {
            let html = '<div style="font-size: 0.95rem;"><strong>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Fam√≠lia:</strong><br>';
            let hasRelations = false;

            // Padre
            if (persona.pareId) {
                const pare = dadesAniversaris.find(p => p.rowNumber === persona.pareId);
                if (pare) {
                    html += `<div style="margin-top: 8px;">üë® Pare: ${pare.nom}</div>`;
                    hasRelations = true;
                }
            }

            // Madre
            if (persona.mareId) {
                const mare = dadesAniversaris.find(p => p.rowNumber === persona.mareId);
                if (mare) {
                    html += `<div style="margin-top: 8px;">üë© Mare: ${mare.nom}</div>`;
                    hasRelations = true;
                }
            }

            // Pareja
            if (persona.parellaId) {
                const parella = dadesAniversaris.find(p => p.rowNumber === persona.parellaId);
                if (parella) {
                    const icon = parella.genere === 'H' ? 'üë®' : 'üë©';
                    const statusText = persona.estatRelacio === 'Actual' ? ' (Actual)' :
                                      persona.estatRelacio === 'Pasada' ? ' (Passada)' : '';
                    const statusBadge = persona.estatRelacio === 'Actual' ? ' üíö' :
                                       persona.estatRelacio === 'Pasada' ? ' ü§ù' : '';
                    html += `<div style="margin-top: 8px;">${icon} Parella${statusText}: ${parella.nom}${statusBadge}</div>`;
                    hasRelations = true;
                }
            }

            // Hijos
            const fills = dadesAniversaris.filter(p =>
                p.pareId === persona.rowNumber || p.mareId === persona.rowNumber
            );
            if (fills.length > 0) {
                html += `<div style="margin-top: 8px;">üë∂ Fills: ${fills.map(f => f.nom).join(', ')}</div>`;
                hasRelations = true;
            }

            // Hermanos
            if (persona.pareId || persona.mareId) {
                const germans = dadesAniversaris.filter(p =>
                    p.rowNumber !== persona.rowNumber &&
                    ((p.pareId && p.pareId === persona.pareId) || (p.mareId && p.mareId === persona.mareId))
                );
                if (germans.length > 0) {
                    html += `<div style="margin-top: 8px;">üë´ Germans: ${germans.map(g => g.nom).join(', ')}</div>`;
                    hasRelations = true;
                }
            }

            html += '</div>';
            return hasRelations ? html : '';
        }

        // Listener para cerrar modal con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const treeModal = document.getElementById('familyTreeModal');
                if (treeModal.classList.contains('show')) {
                    closeFamilyTree();
                }
            }
        });

        // Listener para cerrar tarjetas expandidas al hacer click fuera
        document.addEventListener('click', (e) => {
            const treeModal = document.getElementById('familyTreeModal');
            if (!treeModal || !treeModal.classList.contains('show')) {
                return;
            }

            // Si el click fue en una tarjeta o sus hijos, no hacer nada
            if (e.target.closest('.family-list-card')) {
                return;
            }

            // Cerrar todas las tarjetas expandidas
            document.querySelectorAll('.family-card-expanded').forEach(card => {
                card.classList.remove('family-card-expanded');
                const panel = card.querySelector('.family-relations-panel');
                if (panel) panel.remove();
            });
        });

        // ============================================
        // FIN M√ìDULO DE √ÅRBOL GENEAL√ìGICO
        // ============================================

        // Variables para gesti√≥n de datos
        let currentEditingIndex = -1;
        let currentEditingPerson = null;
        let currentView = 'chart';
        let currentYear = new Date().getFullYear();

        // Funci√≥n para cargar datos desde Google Sheets (con fallback a localStorage)
        async function loadDataFromStorage(refreshUI = false) {
            // Mostrar indicador de carga (DESACTIVADO)
            // const loadingDiv = document.createElement('div');
            // loadingDiv.id = 'loadingIndicator';
            // loadingDiv.style.cssText = `
            //     position: fixed;
            //     top: 50%;
            //     left: 50%;
            //     transform: translate(-50%, -50%);
            //     background: rgba(0,0,0,0.8);
            //     color: white;
            //     padding: 20px 40px;
            //     border-radius: 10px;
            //     z-index: 10001;
            //     font-size: 1rem;
            // `;
            // loadingDiv.innerHTML = '‚è≥ Carregant dades...';
            // document.body.appendChild(loadingDiv);

            try {
                // Intentar cargar desde Google Sheets
                const sheetData = await fetchBirthdays();

                if (sheetData && sheetData.length > 0) {
                    // √âxito: usar datos de Google Sheets
                    dadesAniversaris.length = 0; // Limpiar array existente
                    dadesAniversaris.push(...sheetData);

                    // Guardar en localStorage como cach√©
                    saveDataToStorage();

                    console.log(`‚úÖ Cargados ${sheetData.length} aniversarios desde Google Sheets`);
                    // showSyncMessage('‚úÖ Dades sincronitzades amb Google Sheets');
                } else {
                    // Fallback: usar localStorage si existe
                    const stored = localStorage.getItem('birthdayData');
                    if (stored) {
                        try {
                            const localData = JSON.parse(stored);
                            dadesAniversaris.length = 0;
                            dadesAniversaris.push(...localData);
                            console.log('‚ö†Ô∏è Usando datos de cach√© local');
                            // showSyncMessage('‚ö†Ô∏è Usant dades locals (sense connexi√≥)', true);
                        } catch (e) {
                            console.error('Error cargando desde localStorage:', e);
                        }
                    }
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);

                // Fallback: usar localStorage
                const stored = localStorage.getItem('birthdayData');
                if (stored) {
                    try {
                        const localData = JSON.parse(stored);
                        dadesAniversaris.length = 0;
                        dadesAniversaris.push(...localData);
                        // showSyncMessage('‚ö†Ô∏è Error de connexi√≥. Usant dades locals', true);
                    } catch (e) {
                        console.error('Error cargando desde localStorage:', e);
                    }
                }
            } finally {
                // Quitar indicador de carga (DESACTIVADO)
                // loadingDiv.remove();
            }

            // Refrescar UI si se solicita
            if (refreshUI) {
                console.log('üîÑ loadDataFromStorage amb refreshUI=true, cridant refreshAllViews()');
                refreshAllViews();
            }
        }

        // Funci√≥n para guardar datos en localStorage
        function saveDataToStorage() {
            localStorage.setItem('birthdayData', JSON.stringify(dadesAniversaris));
        }

        // Funci√≥n para switch entre vistas
        // Funci√≥n para renderizar resultados de b√∫squeda
        function renderSearchResults() {
            const searchResultsContainer = document.getElementById('searchResults');

            // Si no hay b√∫squeda, ocultar resultados
            if (filteredData.length === 0 && !currentSearchTerm) {
                searchResultsContainer.style.display = 'none';
                searchResultsContainer.innerHTML = '';
                return;
            }

            // Mostrar contenedor de resultados
            searchResultsContainer.style.display = 'block';

            if (filteredData.length === 0) {
                searchResultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 12px; color: #666;">
                        <h3 style="margin: 0 0 5px 0;">üòï No s'han trobat resultats</h3>
                        <p style="margin: 0;">Prova amb un altre nom</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="padding: 15px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 15px 0; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.1rem;">
                        üîç ${filteredData.length} resultat${filteredData.length !== 1 ? 's' : ''} trobat${filteredData.length !== 1 ? 's' : ''}
                    </h3>
                    <div style="display: grid; gap: 10px;">
            `;

            filteredData.forEach(person => {
                const dateDisplay = formatBirthdayDisplay(person);
                const icon = person.viu === 'No' ? 'üïäÔ∏è' : 'üìÖ';
                html += `
                    <div onclick='showBirthdayDetails(${JSON.stringify(person).replace(/'/g, "\\'")})'
                         style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 10px; color: white; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);"
                         onmouseover="this.style.transform='scale(1.02)'"
                         onmouseout="this.style.transform='scale(1)'">
                        <div style="font-weight: 600; font-size: 1rem; margin-bottom: 3px;">${person.nom}</div>
                        <div style="opacity: 0.9; font-size: 0.85rem;">${icon} ${dateDisplay}</div>
                        ${person.telefon ? `<div style="opacity: 0.9; font-size: 0.85rem;">üì± ${person.telefon}</div>` : ''}
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            searchResultsContainer.innerHTML = html;
        }

        // Funci√≥n centralizada para refrescar todas las vistas
        function refreshAllViews() {
            console.log('üîÑ refreshAllViews() called');
            console.log('üìä Datos actuals:', dadesAniversaris.length, 'aniversaris');

            const mesSelector = document.getElementById('mesSelector');
            const currentMonth = parseInt(mesSelector.value);
            console.log('üìÖ Mes actual:', currentMonth);

            // Detectar quin tipus de vista est√† visible
            const calendarView = document.getElementById('calendarView');
            const chartContainer = document.getElementById('chartContainer');

            // Refrescar vista actual basant-nos en qu√® est√† visible al DOM
            if (chartContainer && chartContainer.style.display !== 'none') {
                console.log('üìà Refrescant gr√†fic...');
                actualitzarGrafic(currentMonth);
            } else if (calendarView) {
                console.log('üìÜ Refrescant calendari...');
                renderCalendar(currentMonth, currentYear);
            }

            // Refrescar widgets dependientes
            updateUpcomingBirthdays();
            updateMonthStats(currentMonth);

            // Si hay b√∫squeda activa, actualizar resultados
            if (currentSearchTerm) {
                renderSearchResults();
            }

            console.log('‚úÖ refreshAllViews() completat');
        }

        // Funci√≥n para renderizar calendario
        function renderCalendar(mes, year = currentYear) {
            year = year || currentYear;
            const firstDay = new Date(year, mes - 1, 1).getDay();
            const daysInMonth = getDiesMes(mes);
            const daysInPrevMonth = getDiesMes(mes - 1);

            const dayNames = ['Dl', 'Dt', 'Dc', 'Dj', 'Dv', 'Ds', 'Dg'];
            const aniversarisMes = dadesAniversaris.filter(d => d.dia && d.mes && d.mes === mes);

            let html = `<div class="calendar-header">
                <h3 style="margin: 0; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.3rem;">${getMesName(mes)} ${year}</h3>
            </div>
            <div class="calendar-grid">`;

            // Headers
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            // D√≠as del mes anterior
            const startDay = firstDay === 0 ? 6 : firstDay - 1;
            for (let i = startDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${daysInPrevMonth - i}</div>
                </div>`;
            }

            // D√≠as del mes actual
            const today = new Date();
            const todayDay = today.getDate();
            const todayMonth = today.getMonth() + 1;
            const todayYear = today.getFullYear();

            for (let day = 1; day <= daysInMonth; day++) {
                const birthdays = aniversarisMes.filter(d => d.dia === day);
                const hasBirthday = birthdays.length > 0;
                const birthdayClass = hasBirthday ? 'has-birthday' : '';
                const isToday = (day === todayDay && mes === todayMonth && year === todayYear);
                const todayClass = isToday ? 'is-today' : '';

                html += `<div class="calendar-day ${birthdayClass} ${todayClass}" onclick="showCalendarDayDetails(${day}, ${mes})">
                    <div class="calendar-day-number">${day}</div>`;

                if (hasBirthday) {
                    html += `<div class="calendar-birthday-count">${birthdays.length}</div>`;
                    html += `<div class="calendar-birthday-names">`;
                    birthdays.forEach((b, i) => {
                        if (i < 2) {
                            const displayDate = b.viu === 'No' && b.anyNaixement
                                ? ` (${b.anyNaixement}${b.anyMort ? '-' + b.anyMort : ''})`
                                : '';
                            const icon = b.viu === 'No' ? ' üïäÔ∏è' : '';
                            html += `${b.nom.split(' ')[0]}${displayDate}${icon}<br>`;
                        }
                    });
                    if (birthdays.length > 2) {
                        html += `+${birthdays.length - 2}`;
                    }
                    html += `</div>`;
                }

                html += `</div>`;
            }

            // D√≠as del siguiente mes
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 1; i <= remainingCells; i++) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${i}</div>
                </div>`;
            }

            html += '</div>';
            document.getElementById('calendarContent').innerHTML = html;
        }

        // Funci√≥n para manejar la selecci√≥n del desplegable
        function selectBirthdayFromDropdown(dia, mes) {
            const selector = document.getElementById('birthdaySelector');
            const selectedIndex = parseInt(selector.value);

            if (selectedIndex >= 0 && window.currentDayBirthdays) {
                const selectedBirthday = window.currentDayBirthdays[selectedIndex];
                showBirthdayDetails(selectedBirthday);
            }
        }

        // Funci√≥n para mostrar detalles de un d√≠a del calendario
        function showCalendarDayDetails(dia, mes) {
            const birthdays = dadesAniversaris.filter(d => d.dia && d.mes && d.mes === mes && d.dia === dia);
            if (birthdays.length === 1) {
                showBirthdayDetails(birthdays[0]);
            } else if (birthdays.length > 1) {
                // Mostrar selector desplegable para m√∫ltiples cumplea√±os
                const modal = document.getElementById('detailsModal');
                document.getElementById('detailsName').textContent = `${dia} ${getMesName(mes)}`;
                document.getElementById('detailsDate').parentElement.innerHTML = `<strong>üéÇ Selecciona una persona:</strong>`;

                // Crear selector desplegable
                const selectHTML = `
                    <select id="birthdaySelector" style="width: 100%; padding: 10px; font-size: 1rem; border: 2px solid #6366f1; border-radius: 8px; margin-top: 5px; cursor: pointer;" onchange="selectBirthdayFromDropdown(${dia}, ${mes})">
                        <option value="">-- Tria un aniversari --</option>
                        ${birthdays.map((b, index) =>
                            `<option value="${index}">${b.nom}</option>`
                        ).join('')}
                    </select>
                `;

                document.getElementById('detailsPhone').parentElement.innerHTML = selectHTML;
                document.getElementById('detailsDays').parentElement.style.display = 'none';

                // Guardar birthdays temporalmente para acceder desde el selector
                window.currentDayBirthdays = birthdays;

                modal.classList.add('show');
            }
        }

        // Gesti√≥n de formularios
        function openAddModal() {
            document.getElementById('formTitle').textContent = 'Afegir Aniversari';
            document.getElementById('formNom').value = '';
            document.getElementById('formDia').value = '';
            document.getElementById('formMes').value = '';
            document.getElementById('formAnyNaixement').value = '';
            document.getElementById('formTelefon').value = '';
            document.getElementById('formEmail').value = '';
            document.getElementById('formGenere').value = '';
            document.getElementById('formViu').value = '';

            // Limpiar campos de relaciones familiares
            document.getElementById('formPare').value = '';
            document.getElementById('formMare').value = '';
            document.getElementById('formParella').value = '';
            document.getElementById('formUrlFoto').value = '';

            // Limpiar nuevos campos
            document.getElementById('formLlocNaixement').value = '';
            document.getElementById('formAnyMort').value = '';
            document.getElementById('formAnyMortContainer').style.display = 'none';

            // Poblar dropdowns de relaciones
            populateFamilyDropdowns();

            document.getElementById('deleteBtn').classList.add('hidden');
            currentEditingIndex = -1;
            currentEditingPerson = null;
            document.getElementById('formModal').classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevenir scroll del body
        }

        function openEditModal() {
            if (!currentEditingPerson) return;

            document.getElementById('formTitle').textContent = 'Editar Aniversari';
            document.getElementById('formNom').value = currentEditingPerson.nom;
            document.getElementById('formDia').value = currentEditingPerson.dia;
            document.getElementById('formMes').value = currentEditingPerson.mes;
            document.getElementById('formAnyNaixement').value = currentEditingPerson.anyNaixement || '';
            document.getElementById('formTelefon').value = currentEditingPerson.telefon || '';
            document.getElementById('formEmail').value = currentEditingPerson.email || '';
            document.getElementById('formGenere').value = currentEditingPerson.genere || '';
            document.getElementById('formViu').value = currentEditingPerson.viu || '';

            // Poblar y cargar valores de relaciones familiares
            populateFamilyDropdowns(currentEditingPerson.rowNumber);
            document.getElementById('formPare').value = currentEditingPerson.pareId || '';
            document.getElementById('formMare').value = currentEditingPerson.mareId || '';
            document.getElementById('formParella').value = currentEditingPerson.parellaId || '';
            document.getElementById('formEstatRelacio').value = currentEditingPerson.estatRelacio || '';
            document.getElementById('formUrlFoto').value = currentEditingPerson.urlFoto || '';

            // Cargar nuevos campos
            document.getElementById('formLlocNaixement').value = currentEditingPerson.llocNaixement || '';
            document.getElementById('formAnyMort').value = currentEditingPerson.anyMort || '';

            // Mostrar anyMort si persona est√° fallecida
            if (currentEditingPerson.viu === 'No') {
                document.getElementById('formAnyMortContainer').style.display = 'block';
            } else {
                document.getElementById('formAnyMortContainer').style.display = 'none';
            }

            document.getElementById('deleteBtn').classList.remove('hidden');

            // Encontrar √≠ndice Y preservar rowNumber para identificaci√≥n precisa
            // Si hay rowNumber, usarlo para mayor precisi√≥n; si no, usar solo nom/dia/mes
            currentEditingIndex = dadesAniversaris.findIndex(d => {
                if (currentEditingPerson.rowNumber && d.rowNumber) {
                    // Si ambos tienen rowNumber, usarlo (m√°s confiable)
                    return d.rowNumber === currentEditingPerson.rowNumber;
                } else {
                    // Fallback a comparaci√≥n por nom, dia, mes
                    return d.nom === currentEditingPerson.nom &&
                           d.dia === currentEditingPerson.dia &&
                           d.mes === currentEditingPerson.mes;
                }
            });

            console.log('openEditModal - currentEditingPerson:', currentEditingPerson);
            console.log('openEditModal - currentEditingIndex:', currentEditingIndex);
            console.log('openEditModal - dadesAniversaris[0] example:', dadesAniversaris[0]);

            closeDetailsModal();
            document.getElementById('formModal').classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevenir scroll del body
        }

        function closeFormModal() {
            document.getElementById('formModal').classList.remove('show');
            currentEditingIndex = -1;
            currentEditingPerson = null;
            document.body.style.overflow = ''; // Restaurar scroll del body
        }

        async function saveBirthday() {
            const nom = document.getElementById('formNom').value.trim();
            const dia = parseInt(document.getElementById('formDia').value);
            const mes = parseInt(document.getElementById('formMes').value);
            const anyNaixement = document.getElementById('formAnyNaixement').value ? parseInt(document.getElementById('formAnyNaixement').value) : null;
            let telefon = document.getElementById('formTelefon').value.trim();
            let email = document.getElementById('formEmail').value.trim();
            const genere = document.getElementById('formGenere').value;
            const viu = document.getElementById('formViu').value;

            // Validar campos obligatorios y mostrar modal si falta alguno
            const missingFields = [];
            if (!nom) missingFields.push('Nom');
            if (!dia) missingFields.push('Dia');
            if (!mes) missingFields.push('Mes');
            if (!anyNaixement) missingFields.push('Any de naixement');
            if (!telefon) missingFields.push('Tel√®fon');
            if (!email) missingFields.push('Email');
            if (!genere) missingFields.push('G√®nere');
            if (!viu) missingFields.push('Estat');

            if (missingFields.length > 0) {
                showConfirmModal(missingFields);
                return;
            }

            // Continuar con el guardado normal
            await saveBirthdayConfirmed();
        }

        // Funci√≥n que realmente guarda el cumplea√±os (se llama despu√©s de validar o confirmar)
        async function saveBirthdayConfirmed() {
            const nom = document.getElementById('formNom').value.trim();
            const dia = parseInt(document.getElementById('formDia').value);
            const mes = parseInt(document.getElementById('formMes').value);
            const anyNaixement = document.getElementById('formAnyNaixement').value ? parseInt(document.getElementById('formAnyNaixement').value) : null;
            let telefon = document.getElementById('formTelefon').value.trim();
            let email = document.getElementById('formEmail').value.trim();
            const genere = document.getElementById('formGenere').value;
            const viu = document.getElementById('formViu').value;

            // Capturar campos de relaciones familiares
            const pareId = document.getElementById('formPare').value ? parseInt(document.getElementById('formPare').value) : null;
            const mareId = document.getElementById('formMare').value ? parseInt(document.getElementById('formMare').value) : null;
            const parellaId = document.getElementById('formParella').value ? parseInt(document.getElementById('formParella').value) : null;
            const urlFoto = document.getElementById('formUrlFoto').value.trim();
            const estatRelacio = document.getElementById('formEstatRelacio')?.value || '';

            // Capturar nuevos campos
            const llocNaixement = document.getElementById('formLlocNaixement').value.trim();
            const anyMort = document.getElementById('formAnyMort').value ? parseInt(document.getElementById('formAnyMort').value) : null;

            // Validar relaciones circulares
            if (pareId && mareId && pareId === mareId) {
                alert('El pare i la mare no poden ser la mateixa persona');
                return;
            }

            if (currentEditingPerson && currentEditingPerson.rowNumber) {
                if (pareId === currentEditingPerson.rowNumber) {
                    alert('Una persona no pot ser el seu propi pare');
                    return;
                }
                if (mareId === currentEditingPerson.rowNumber) {
                    alert('Una persona no pot ser la seva pr√≤pia mare');
                    return;
                }
                if (parellaId === currentEditingPerson.rowNumber) {
                    alert('Una persona no pot ser la seva pr√≤pia parella');
                    return;
                }
            }

            // Validaciones b√°sicas de formato
            if (dia < 1 || dia > 31) {
                alert('El dia ha de ser entre 1 i 31');
                return;
            }

            if (mes < 1 || mes > 12) {
                alert('El mes ha de ser entre 1 (Gener) i 12 (Desembre)');
                return;
            }

            // Validar que el d√≠a sea correcto seg√∫n el mes
            const diasPorMes = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            const maxDia = diasPorMes[mes - 1];

            if (dia > maxDia) {
                const nombresMeses = ['Gener', 'Febrer', 'Mar√ß', 'Abril', 'Maig', 'Juny', 'Juliol', 'Agost', 'Setembre', 'Octubre', 'Novembre', 'Desembre'];
                alert(`El mes de ${nombresMeses[mes - 1]} nom√©s t√© ${maxDia} dies`);
                return;
            }

            // Validar formato de tel√©fono si se ha introducido
            if (telefon) {
                // Remover espacios, guiones y par√©ntesis
                telefon = telefon.replace(/[\s\-\(\)]/g, '');

                // Validar que solo contenga n√∫meros y opcionalmente +
                const telefonRegex = /^\+?[0-9]{9,15}$/;
                if (!telefonRegex.test(telefon)) {
                    alert('El tel√®fon ha de tenir entre 9 i 15 d√≠gits i pot comen√ßar amb +\nExemple: +34666777888 o 666777888');
                    return;
                }
            }

            // Validar formato de email si se ha introducido
            if (email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('El format del correu electr√≤nic no √©s v√†lid\nExemple: nom@exemple.com');
                    return;
                }
            }

            const isEditing = currentEditingIndex >= 0;
            const oldBirthday = isEditing ? { ...dadesAniversaris[currentEditingIndex] } : null; // Deep copy para preservar rowNumber

            const newBirthday = { nom, dia, mes, anyNaixement, telefon, email, genere, viu, pareId, mareId, parellaId, urlFoto, estatRelacio, llocNaixement, anyMort };

            // Si est√° editando, preservar rowNumber del dato antiguo
            if (isEditing && oldBirthday && oldBirthday.rowNumber) {
                newBirthday.rowNumber = oldBirthday.rowNumber;
            }

            // Actualizar datos localmente (inmediato)
            if (isEditing) {
                // Editar existente - preservar rowNumber
                dadesAniversaris[currentEditingIndex] = newBirthday;
            } else {
                // Agregar nuevo - no rowNumber a√∫n (se asignar√° despu√©s del sync)
                dadesAniversaris.push(newBirthday);
            }

            saveDataToStorage();
            closeFormModal();

            // Refrescar vistas inmediatamente
            const mesSelector = document.getElementById('mesSelector');
            const selectedMonth = parseInt(mesSelector.value);
            renderCalendar(selectedMonth, getYearForMonth(selectedMonth));
            updateUpcomingBirthdays();
            updateMonthStats(mesSelector.value);

            // Sincronizar con Google Sheets en segundo plano
            if (isEditing) {
                // Actualizar en Google Sheets - enviar oldBirthday con rowNumber
                const success = await updateBirthdayInSheet(oldBirthday, newBirthday);
                if (success) {
                    // Recargar datos para refrescar rowNumbers
                    await loadDataFromStorage(true);
                    showSyncMessage('‚úÖ Canvis fets', false);
                } else {
                    showSyncMessage('‚ö†Ô∏è Error al sincronitzar. Canvis guardats localment', true);
                }
            } else {
                // A√±adir a Google Sheets
                const result = await addBirthdayToSheet(newBirthday);

                // Manejar diferentes tipos de error
                if (result && result.success === false) {
                    // Revertir cambio local
                    dadesAniversaris.pop();
                    saveDataToStorage();
                    const selectedMonth2 = parseInt(mesSelector.value);
                    renderCalendar(selectedMonth2, getYearForMonth(selectedMonth2));
                    updateUpcomingBirthdays();
                    updateMonthStats(mesSelector.value);

                    if (result.tipo === 'duplicadoExacto') {
                        alert(result.error);
                        return;
                    }

                    if (result.tipo === 'nombresSimilares') {
                        const confirmar = confirm(
                            result.error + '\n\n' +
                            'Vols afegir igualment "' + nom + '"?'
                        );

                        if (confirmar) {
                            // Usuario confirma: forzar creaci√≥n
                            const resultForzado = await addBirthdayToSheetForzado(newBirthday);

                            if (resultForzado && resultForzado.success) {
                                // Agregar localmente de nuevo
                                dadesAniversaris.push(newBirthday);
                                saveDataToStorage();
                                const selectedMonth3 = parseInt(mesSelector.value);
                                renderCalendar(selectedMonth3, getYearForMonth(selectedMonth3));
                                updateUpcomingBirthdays();
                                updateMonthStats(mesSelector.value);
                                await loadDataFromStorage(true);
                                showSyncMessage('‚úÖ Canvis fets', false);
                            } else {
                                alert('Error al afegir aniversari: ' + (resultForzado?.error || 'Error desconegut'));
                            }
                        }
                        return;
                    }

                    alert(result.error || 'Error al afegir aniversari');
                    return;
                }

                if (result && result.success) {
                    // Recargar datos para obtener rowNumber asignado
                    await loadDataFromStorage(true);
                    showSyncMessage('‚úÖ Canvis fets', false);
                }
            }
        }

        // Funciones para manejar el modal de confirmaci√≥n de campos incompletos
        function showConfirmModal(missingFields) {
            const modal = document.getElementById('confirmModal');
            const list = document.getElementById('missingFieldsList');

            // Limpiar lista anterior
            list.innerHTML = '';

            // Agregar campos faltantes a la lista
            missingFields.forEach(field => {
                const li = document.createElement('li');
                li.textContent = field;
                list.appendChild(li);
            });

            // Mostrar modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        async function saveAnywayConfirmed() {
            closeConfirmModal();
            await saveBirthdayConfirmed();
        }

        async function deleteBirthday() {
            console.log('deleteBirthday called, currentEditingIndex:', currentEditingIndex);
            console.log('currentEditingPerson:', currentEditingPerson);

            if (currentEditingIndex < 0) {
                console.error('No se puede eliminar: currentEditingIndex es', currentEditingIndex);
                alert('Error: No se ha seleccionado ning√∫n aniversario para eliminar');
                return;
            }

            if (confirm('Est√†s segur que vols eliminar aquest aniversari?')) {
                // Guardar referencia completa antes de eliminar (incluye rowNumber)
                const deletedBirthday = { ...dadesAniversaris[currentEditingIndex] };

                // Eliminar localmente (inmediato)
                dadesAniversaris.splice(currentEditingIndex, 1);
                saveDataToStorage();
                closeFormModal();

                // Refrescar vistas inmediatamente
                const mesSelector = document.getElementById('mesSelector');
                if (currentView === 'chart') {
                    actualitzarGrafic(mesSelector.value);
                } else {
                    const selectedMonth4 = parseInt(mesSelector.value);
                    renderCalendar(selectedMonth4, getYearForMonth(selectedMonth4));
                }

                updateUpcomingBirthdays();
                updateMonthStats(mesSelector.value);

                // Sincronizar con Google Sheets en segundo plano
                console.log('üóëÔ∏è Eliminant de Google Sheets:', deletedBirthday.nom);
                const success = await deleteBirthdayFromSheet(deletedBirthday);
                console.log('üìù Resultat eliminaci√≥:', success ? '√àxit' : 'Error');

                if (success) {
                    console.log('üì• Recarregant dades de Google Sheets...');
                    // Recargar datos para refrescar rowNumbers despu√©s de eliminaci√≥n
                    await loadDataFromStorage(true);
                    console.log('‚úÖ Dades recarregades i calendari refrescat');
                    showSyncMessage('‚úÖ Canvis fets', false);
                } else {
                    showSyncMessage('‚ö†Ô∏è Error al sincronitzar. Canvis guardats localment', true);
                }
            }
        }

        // Gestos m√≥viles (swipe)
        let touchStartX = 0;
        let touchEndX = 0;

        function handleSwipe() {
            const threshold = 50;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > threshold) {
                const mesSelector = document.getElementById('mesSelector');
                let currentMes = parseInt(mesSelector.value);

                if (diff > 0) {
                    // Swipe left - siguiente mes
                    if (currentMes === 12) {
                        currentMes = 1;
                        currentYear++; // Incrementar a√±o
                    } else {
                        currentMes++;
                    }
                } else {
                    // Swipe right - mes anterior
                    if (currentMes === 1) {
                        currentMes = 12;
                        currentYear--; // Decrementar a√±o
                    } else {
                        currentMes--;
                    }
                }

                mesSelector.value = currentMes;
                renderCalendar(currentMes, currentYear);
                updateMonthStats(currentMes);
            }
        }

        async function initializeApp() {
            // Cargar datos desde Google Sheets
            await loadDataFromStorage();

            const mesActual = new Date().getMonth() + 1;
            const mesSelector = document.getElementById('mesSelector');
            const mesos = ["Gener", "Febrer", "Mar√ß", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];

            // Limpiar opciones existentes antes de a√±adir nuevas
            mesSelector.innerHTML = '';

            // Llenar el selector de meses
            mesos.forEach((mes, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.text = mes;
                mesSelector.appendChild(option);
            });

            mesSelector.value = mesActual;
            renderCalendar(mesActual, currentYear);
            updateMonthStats(mesActual);

            // A√±adir event listener para cambio de mes
            mesSelector.addEventListener('change', function() {
                const selectedMonth = parseInt(this.value);
                renderCalendar(selectedMonth, getYearForMonth(selectedMonth));
                updateMonthStats(this.value);
            });
            // Event listener para b√∫squeda
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value;
                searchBirthdays(searchTerm);
                renderSearchResults(); // Mostrar resultados en contenedor separado
            });

            // Event listener para cerrar modal al hacer click fuera
            document.getElementById('detailsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDetailsModal();
                }
            });

            // Event listener para toggle de tema
            document.getElementById('themeToggle').addEventListener('click', toggleDarkMode);

            // Event listener para mostrar/ocultar campo anyMort
            document.getElementById('formViu').addEventListener('change', function() {
                const anyMortContainer = document.getElementById('formAnyMortContainer');
                if (this.value === 'No') {
                    anyMortContainer.style.display = 'block';
                } else {
                    anyMortContainer.style.display = 'none';
                    document.getElementById('formAnyMort').value = '';
                }
            });

            // Inicializar modo oscuro si estaba activado
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }

            checkMobileSize();

            // Iniciar widget de pr√≥ximo cumplea√±os
            updateUpcomingBirthdays();
            setInterval(updateUpcomingBirthdays, 1000); // Cada segundo para actualizar el contador

            // Mostrar botones flotantes
            document.getElementById('addBtn').classList.remove('hidden');
            document.getElementById('treeBtn').classList.remove('hidden');

            // Event listeners para swipe
            const container = document.querySelector('.container');
            container.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            container.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            // Event listener para cerrar modal de formulario al hacer click fuera
            document.getElementById('formModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFormModal();
                }
            });

            // Cargar datos al inicio si hay en localStorage
            loadDataFromStorage();
        }

        function checkMobileSize() {
            if (window.innerWidth <= 768) {
                document.querySelectorAll('.imatge-container img').forEach(img => {
                    img.style.maxWidth = '90%';
                });
            } else {
                document.querySelectorAll('.imatge-container img').forEach(img => {
                    img.style.maxWidth = '60%';
                });
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Comprobar si ya estamos autenticados y la sesi√≥n es v√°lida
            if (isSessionValid()) {
                document.getElementById('passwordModal').style.display = 'none';
                document.querySelector('.mainContent').classList.remove('hidden');
                document.getElementById('chat-toggle').style.display = 'flex';
                initializeApp();
            } else {
                // Limpiar datos de autenticaci√≥n expirados
                localStorage.removeItem('victorCatalaAuth');
                localStorage.removeItem('victorCatalaAuthTime');
            }

            // Event listener para Enter en la contrase√±a
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // Event listener para cerrar sesi√≥n
            document.getElementById('logoutButton').addEventListener('click', function() {
                localStorage.removeItem('victorCatalaAuth');
                localStorage.removeItem('victorCatalaAuthTime');
                document.getElementById('passwordModal').style.display = 'flex';
                document.querySelector('.mainContent').classList.add('hidden');
                document.getElementById('chat-toggle').style.display = 'none';
                document.getElementById('chat-wrapper').style.display = 'none';
                document.getElementById('passwordInput').value = '';
            });
        });
        
        // Ajustar tama√±o al cambiar la orientaci√≥n del dispositivo
        let resizeTimeout;
        window.addEventListener('resize', function() {
            checkMobileSize();

            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Re-renderizar calendario
                const mesSelector = document.getElementById('mesSelector');
                if (mesSelector && mesSelector.value) {
                    renderCalendar(parseInt(mesSelector.value), currentYear);
                }

                // Re-renderizar √°rbol si el modal est√° abierto
                const treeModal = document.getElementById('familyTreeModal');
                if (treeModal && treeModal.classList.contains('show')) {
                    // Preservar valor del buscador antes de re-renderizar
                    const treeSearchInput = document.getElementById('treeSearchInput');
                    const searchValue = treeSearchInput ? treeSearchInput.value : '';

                    renderFamilyList();
                    setupTreeSearch();

                    // Restaurar valor del buscador y re-aplicar filtro
                    if (searchValue && treeSearchInput) {
                        treeSearchInput.value = searchValue;
                        treeSearchInput.dispatchEvent(new Event('input'));
                    }
                }
            }, 300); // Debounce 300ms
        });

        // Activar animaciones al tocar el widget
        document.addEventListener('DOMContentLoaded', function() {
            const widget = document.getElementById('upcomingWidget');
            let animationTimeout;

            if (widget) {
                widget.addEventListener('click', function() {
                    // A√±adir clase active
                    this.classList.add('active');

                    // Limpiar timeout anterior si existe
                    if (animationTimeout) {
                        clearTimeout(animationTimeout);
                    }

                    // Quitar clase despu√©s de 5 segundos
                    animationTimeout = setTimeout(() => {
                        this.classList.remove('active');
                    }, 5000);
                });
            }
        });

        // Control del video para inicio aleatorio
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.getElementById('escolaVideo');

            if (video) {
                // Cuando se carguen los metadatos del video (duraci√≥n disponible)
                video.addEventListener('loadedmetadata', function() {
                    // Establecer posici√≥n aleatoria entre 0 y la duraci√≥n del video
                    video.currentTime = Math.random() * video.duration;
                });

                // Asegurar que el video vuelva al inicio cuando termine
                // (el atributo loop ya deber√≠a hacer esto, pero por seguridad)
                video.addEventListener('ended', function() {
                    video.currentTime = 0;
                    video.play();
                });
            }
        });
    </script>

<!-- Estilos del chat -->
<style>
/* Bot√≥n flotante para abrir chat */
#chat-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 15px 25px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

#chat-toggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
}

/* Contenedor del chat */
#chat-wrapper {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 400px;
    height: 600px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 3000;
    flex-direction: column;
    overflow: hidden;
}

/* Header del chat */
.chat-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

#chat-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 24px;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

#chat-close:hover {
    background: rgba(255,255,255,0.3);
}

.chat-header-buttons {
    display: flex;
    gap: 8px;
}

#chat-reset {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 18px;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

#chat-reset:hover {
    background: rgba(255,255,255,0.3);
}

/* √Årea de mensajes */
#chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f5f5f5;
}

.message {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user {
    align-items: flex-end;
}

.message.bot {
    align-items: flex-start;
}

.message-bubble {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    line-height: 1.4;
}

.message.user .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.message.bot .message-bubble {
    background: white;
    color: #333;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Indicador de escritura */
.typing-indicator {
    display: none;
    padding: 10px 16px;
    background: white;
    border-radius: 18px;
    width: fit-content;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.typing-indicator.active {
    display: block;
}

.typing-indicator span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #667eea;
    margin: 0 2px;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

/* Input del chat */
.chat-input-container {
    padding: 15px;
    background: white;
    border-top: 1px solid #e0e0e0;
    display: flex;
    gap: 10px;
}

#chat-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 20px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.3s;
}

#chat-input:focus {
    border-color: #667eea;
}

#chat-send {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
}

#chat-send:hover:not(:disabled) {
    transform: scale(1.05);
}

#chat-send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Bot√≥n de adjuntar archivo */
#chat-file-btn {
    background: #f0f0f0;
    color: #666;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

#chat-file-btn:hover {
    background: #e0e0e0;
    color: #667eea;
}

#chat-file-input {
    display: none;
}

/* Preview de archivos adjuntos */
.chat-files-preview {
    padding: 10px 15px;
    background: #f9f9f9;
    border-top: 1px solid #e0e0e0;
    display: none;
    flex-wrap: wrap;
    gap: 8px;
}

.chat-files-preview.has-files {
    display: flex;
}

.file-preview-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 16px;
    font-size: 12px;
    color: #666;
}

.file-preview-item img {
    width: 24px;
    height: 24px;
    object-fit: cover;
    border-radius: 4px;
}

.file-preview-item .file-icon {
    font-size: 16px;
}

.file-preview-item .remove-file {
    cursor: pointer;
    color: #999;
    margin-left: 4px;
}

.file-preview-item .remove-file:hover {
    color: #e53935;
}

/* Badge de "powered by" */
.chat-footer {
    padding: 8px;
    text-align: center;
    font-size: 11px;
    color: #999;
    background: #f8f9fa;
    border-top: 1px solid #e0e0e0;
}

/* Responsive */
@media (max-width: 768px) {
    #chat-wrapper {
        width: 100%;
        height: 100vh;
        height: 100dvh; /* Versi√≥n moderna para m√≥vil */
        bottom: 0;
        right: 0;
        left: 0;
        top: 0;
        border-radius: 0;
        box-sizing: border-box;
    }

    #chat-toggle {
        bottom: 80px; /* Por encima del logout button */
        right: 15px;
        padding: 12px 16px;
        font-size: 14px;
    }

    .chat-header {
        padding: 15px;
        padding-top: max(15px, env(safe-area-inset-top)); /* Espacio para notch */
    }

    .chat-header h3 {
        font-size: 16px;
    }

    #chat-close {
        width: 40px;
        height: 40px;
        font-size: 22px;
        flex-shrink: 0;
    }

    #chat-messages {
        padding: 15px;
    }

    .chat-input-container {
        padding: 15px;
        padding-right: max(20px, env(safe-area-inset-right, 20px));
        padding-bottom: max(15px, env(safe-area-inset-bottom));
        flex-wrap: nowrap;
    }

    #chat-send {
        padding: 12px 16px;
        white-space: nowrap;
        flex-shrink: 0;
        margin-right: 5px;
    }
}
</style>

<!-- Bot√≥n para abrir el chat -->
<button id="chat-toggle" type="button">
    üí¨ Assist√®ncia Familiar
</button>

<!-- Contenedor del chat -->
<div id="chat-wrapper">
    <div class="chat-header">
        <h3>üå≥ Gestor Familiar</h3>
        <div class="chat-header-buttons">
            <button id="chat-reset" type="button" aria-label="Nova conversa" title="Nova conversa">üîÑ</button>
            <button id="chat-close" type="button" aria-label="Tancar xat">‚úï</button>
        </div>
    </div>
    
    <div id="chat-messages">
        <div class="message bot">
            <div class="message-bubble">
                Hola! S√≥c el teu gestor familiar amb acc√©s a l'arbre geneal√≤gic. Pregunta'm sobre aniversaris, familiars, o qualsevol informaci√≥. Tamb√© puc analitzar imatges i PDFs (üìé) i buscar a la web! Recorda que s√≥c una IA i puc cometre errors!üå≥
            </div>
        </div>
    </div>
    
    <div id="chat-files-preview" class="chat-files-preview"></div>

    <div class="chat-input-container">
        <button id="chat-file-btn" type="button" title="Adjuntar arxiu (imatge o PDF)">üìé</button>
        <input type="file" id="chat-file-input" accept="image/*,.pdf" multiple>
        <input
            type="text"
            id="chat-input"
            placeholder="Escriu el teu missatge..."
            autocomplete="off"
        >
        <button id="chat-send" type="button">Enviar</button>
    </div>
    
    <div class="chat-footer">
        Powered by @rxampeny ¬∑ <span id="footer-year"></span>
    </div>
</div>

<script>
(function() {
    // API de Chat: Supabase Edge Function (migrado de Railway)
    const CHAT_API_URL = `${SUPABASE_URL}/functions/v1/chat`;
    
    // Elementos del DOM
    const toggleBtn = document.getElementById('chat-toggle');
    const chatWrapper = document.getElementById('chat-wrapper');
    const closeBtn = document.getElementById('chat-close');
    const resetBtn = document.getElementById('chat-reset');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send');
    const fileBtn = document.getElementById('chat-file-btn');
    const fileInput = document.getElementById('chat-file-input');
    const filesPreview = document.getElementById('chat-files-preview');

    // Set dynamic year in footer
    document.getElementById('footer-year').textContent = new Date().getFullYear();

    // Array para almacenar archivos seleccionados
    let selectedFiles = [];
    
    // Funciones de UI
    function openChat() {
        chatWrapper.style.display = 'flex';
        toggleBtn.style.display = 'none';
        chatInput.focus();
    }
    
    function closeChat() {
        chatWrapper.style.display = 'none';
        toggleBtn.style.display = 'flex';
    }

    function resetChat() {
        // Clear all messages
        chatMessages.innerHTML = '';

        // Add initial welcome message back
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'message bot';
        welcomeDiv.innerHTML = `
            <div class="message-bubble">
                Hola! S√≥c el teu gestor familiar amb acc√©s a l'arbre geneal√≤gic. Pregunta'm sobre aniversaris, familiars, o qualsevol informaci√≥. Tamb√© puc analitzar imatges i PDFs (üìé) i buscar a la web! üå≥
            </div>
        `;
        chatMessages.appendChild(welcomeDiv);

        // Clear any selected files
        clearSelectedFiles();

        // Focus input
        chatInput.focus();
    }

    // Agregar mensaje al chat
    function addMessage(text, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = text;
        
        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        
        // Scroll al final
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Mostrar indicador de escritura
    function showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'message bot';
        indicator.id = 'typing-indicator-msg';
        
        const bubble = document.createElement('div');
        bubble.className = 'typing-indicator active';
        bubble.innerHTML = '<span></span><span></span><span></span>';
        
        indicator.appendChild(bubble);
        chatMessages.appendChild(indicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Ocultar indicador de escritura
    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator-msg');
        if (indicator) {
            indicator.remove();
        }
    }

    // Convertir archivo a base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // Mostrar preview de archivos
    function updateFilesPreview() {
        filesPreview.innerHTML = '';
        if (selectedFiles.length === 0) {
            filesPreview.classList.remove('has-files');
            return;
        }
        filesPreview.classList.add('has-files');
        selectedFiles.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'file-preview-item';
            const isImage = file.type.startsWith('image/');
            if (isImage) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                item.appendChild(img);
            } else {
                const icon = document.createElement('span');
                icon.className = 'file-icon';
                icon.textContent = 'üìÑ';
                item.appendChild(icon);
            }
            const name = document.createElement('span');
            name.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;
            item.appendChild(name);
            const remove = document.createElement('span');
            remove.className = 'remove-file';
            remove.textContent = '‚úï';
            remove.onclick = () => {
                selectedFiles.splice(index, 1);
                updateFilesPreview();
            };
            item.appendChild(remove);
            filesPreview.appendChild(item);
        });
    }

    // Manejar selecci√≥n de archivos
    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            if (file.type.startsWith('image/') || file.type === 'application/pdf') {
                if (file.size <= 10 * 1024 * 1024) {
                    selectedFiles.push(file);
                } else {
                    alert(`L'arxiu ${file.name} √©s massa gran (m√†xim 10MB)`);
                }
            }
        });
        updateFilesPreview();
        fileInput.value = '';
    }

    // Limpiar archivos seleccionados
    function clearSelectedFiles() {
        selectedFiles = [];
        updateFilesPreview();
    }

    // Enviar mensaje
    async function sendMessage() {
        const message = chatInput.value.trim();
        const hasFiles = selectedFiles.length > 0;

        if (!message && !hasFiles) return;

        // Mostrar mensaje del usuario con indicador de archivos
        let userDisplay = message;
        if (hasFiles) {
            const fileNames = selectedFiles.map(f => f.name).join(', ');
            userDisplay = message ? `${message} [üìé ${fileNames}]` : `[üìé ${fileNames}]`;
        }
        addMessage(userDisplay, true);
        chatInput.value = '';

        // Deshabilitar input mientras procesa
        sendBtn.disabled = true;
        chatInput.disabled = true;
        fileBtn.disabled = true;

        // Mostrar indicador de escritura
        showTypingIndicator();

        try {
            // Preparar archivos en base64
            const filesData = [];
            for (const file of selectedFiles) {
                const base64 = await fileToBase64(file);
                filesData.push({
                    name: file.name,
                    type: file.type,
                    data: base64
                });
            }

            const response = await fetch(CHAT_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'apikey': SUPABASE_ANON_KEY
                },
                body: JSON.stringify({
                    message: message || 'Analitza aquest arxiu',
                    conversation_history: [],
                    files: filesData
                })
            });

            if (!response.ok) {
                throw new Error('Error al comunicar amb el servidor');
            }

            const data = await response.json();

            // Ocultar indicador
            hideTypingIndicator();

            // Agregar respuesta del bot
            addMessage(data.response, false);

            // Limpiar archivos seleccionados
            clearSelectedFiles();

        } catch (error) {
            hideTypingIndicator();
            console.error('Error:', error);

            // Mensaje de error m√°s informativo
            if (SUPABASE_URL.includes('TU_PROYECTO')) {
                addMessage('‚ö†Ô∏è Configura la URL de Supabase en supabase-client.js. Consulta SUPABASE-MIGRATION.md', false);
            } else {
                addMessage('Ho sento, hi ha hagut un error. Torna-ho a intentar. üòî', false);
            }
        } finally {
            // Re-habilitar input
            sendBtn.disabled = false;
            chatInput.disabled = false;
            fileBtn.disabled = false;
            chatInput.focus();
        }
    }
    
    // Event listeners
    toggleBtn.addEventListener('click', openChat);
    closeBtn.addEventListener('click', closeChat);
    resetBtn.addEventListener('click', resetChat);
    sendBtn.addEventListener('click', sendMessage);

    // File upload listeners
    fileBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Cerrar con ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && chatWrapper.style.display === 'flex') {
            closeChat();
        }
    });
})();
</script>


</body>
</html>

